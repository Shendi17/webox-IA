{% extends "dashboard/base_dashboard.html" %}

{% block title %}Paiement - WeBox{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/checkout.css">
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üí≥ Finaliser votre commande</h1>
    <p>Paiement s√©curis√©</p>
</div>

<div class="checkout-page">
    <!-- √âtapes de progression -->
    <div class="progress-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-label">Informations</div>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-label">Paiement</div>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">Confirmation</div>
        </div>
    </div>

    <div class="checkout-main">
        <!-- Formulaire de paiement -->
        <div class="checkout-form">
            <!-- √âtape 1: Informations -->
            <div class="form-section active" id="step1">
                <h2>üìã Informations de facturation</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                </div>

                <div class="form-group">
                    <label for="phone">T√©l√©phone</label>
                    <input type="tel" id="phone">
                </div>

                <div class="form-group">
                    <label for="company">Entreprise (optionnel)</label>
                    <input type="text" id="company">
                </div>

                <div class="form-group">
                    <label for="address">Adresse *</label>
                    <input type="text" id="address" required>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="city">Ville *</label>
                        <input type="text" id="city" required>
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Code postal *</label>
                        <input type="text" id="postalCode" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="country">Pays *</label>
                    <select id="country" required>
                        <option value="">S√©lectionnez un pays</option>
                        <option value="FR" selected>France</option>
                        <option value="BE">Belgique</option>
                        <option value="CH">Suisse</option>
                        <option value="CA">Canada</option>
                        <option value="US">√âtats-Unis</option>
                    </select>
                </div>

                <button class="btn-next" onclick="goToStep(2)">
                    Continuer vers le paiement ‚Üí
                </button>
            </div>

            <!-- √âtape 2: Paiement -->
            <div class="form-section" id="step2">
                <h2>üí≥ M√©thode de paiement</h2>

                <div class="payment-methods-selector">
                    <div class="payment-method active" data-method="card">
                        <input type="radio" name="payment" id="card" checked>
                        <label for="card">
                            <span class="icon">üí≥</span>
                            <span>Carte bancaire</span>
                        </label>
                    </div>
                    <div class="payment-method" data-method="paypal">
                        <input type="radio" name="payment" id="paypal">
                        <label for="paypal">
                            <span class="icon">üÖøÔ∏è</span>
                            <span>PayPal</span>
                        </label>
                    </div>
                    <div class="payment-method" data-method="bank">
                        <input type="radio" name="payment" id="bank">
                        <label for="bank">
                            <span class="icon">üè¶</span>
                            <span>Virement bancaire</span>
                        </label>
                    </div>
                </div>

                <!-- Formulaire carte bancaire avec Stripe -->
                <div class="payment-form active" id="cardForm">
                    <div class="form-group">
                        <label>Informations de carte *</label>
                        <div id="card-element" style="padding: 1rem; border: 2px solid #e0e0e0; border-radius: 10px; background: white;"></div>
                        <div id="card-errors" role="alert" style="color: #ff6b6b; margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>

                    <div class="security-info">
                        <span class="icon">üîí</span>
                        <span>Paiement 100% s√©curis√© avec Stripe - Cryptage SSL</span>
                    </div>
                    
                    <div class="payment-logos" style="display: flex; gap: 1rem; margin-top: 1rem; opacity: 0.6;">
                        <span>üí≥ Visa</span>
                        <span>üí≥ Mastercard</span>
                        <span>üí≥ Amex</span>
                    </div>
                </div>

                <!-- PayPal -->
                <div class="payment-form" id="paypalForm">
                    <div class="paypal-info">
                        <p>Cliquez sur le bouton ci-dessous pour payer avec PayPal en toute s√©curit√©.</p>
                        <div id="paypal-button-container" style="margin-top: 1.5rem;"></div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                            <strong>Avantages PayPal :</strong><br>
                            ‚úì Protection des achats<br>
                            ‚úì Paiement s√©curis√©<br>
                            ‚úì Pas besoin de saisir vos coordonn√©es bancaires
                        </p>
                    </div>
                </div>

                <!-- Virement bancaire -->
                <div class="payment-form" id="bankForm">
                    <div class="bank-info">
                        <h3 style="margin-bottom: 1rem;">üìã Coordonn√©es bancaires</h3>
                        <div class="bank-details" style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <strong>B√©n√©ficiaire :</strong> WeBox SAS
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong>IBAN :</strong> FR76 XXXX XXXX XXXX XXXX XXXX XXX
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong>BIC :</strong> WBOXFRPP
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong>Banque :</strong> Banque WeBox
                            </div>
                            <div style="padding: 1rem; background: #fff3cd; border-radius: 8px; margin-top: 1rem;">
                                <strong>‚ö†Ô∏è R√©f√©rence √† indiquer :</strong><br>
                                <span id="bankReference" style="font-size: 1.2rem; font-weight: 700; color: #856404;">WB-ORDER-XXXXX</span>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 0.9rem;">
                            <strong>D√©lai de traitement :</strong> 2-3 jours ouvr√©s apr√®s r√©ception du virement.<br>
                            <strong>Important :</strong> N'oubliez pas d'indiquer la r√©f√©rence lors de votre virement.
                        </p>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn-back" onclick="goToStep(1)">
                        ‚Üê Retour
                    </button>
                    <button class="btn-next" id="submitPayment" onclick="processPayment()">
                        Valider le paiement
                    </button>
                </div>
            </div>

            <!-- √âtape 3: Confirmation -->
            <div class="form-section" id="step3">
                <div class="confirmation-content">
                    <div class="success-icon">‚úì</div>
                    <h2>Commande confirm√©e !</h2>
                    <p>Merci pour votre achat. Votre commande a √©t√© trait√©e avec succ√®s.</p>
                    
                    <div class="order-number">
                        <span>Num√©ro de commande :</span>
                        <strong>#WB-2026-001234</strong>
                    </div>

                    <div class="confirmation-details">
                        <p>Un email de confirmation a √©t√© envoy√© √† votre adresse.</p>
                        <p>Vous pouvez acc√©der imm√©diatement √† vos produits depuis votre tableau de bord.</p>
                    </div>

                    <div class="confirmation-actions">
                        <a href="/dashboard" class="btn-dashboard">
                            Aller au tableau de bord
                        </a>
                        <a href="/orders" class="btn-orders">
                            Voir mes commandes
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©sum√© de commande (charg√© dynamiquement) -->
        <div class="order-summary">
            <h2>R√©sum√© de la commande</h2>

            <div class="summary-items" id="checkoutItems">
                <div class="loading">Chargement...</div>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-totals">
                <div class="total-row">
                    <span>Sous-total</span>
                    <span id="checkoutSubtotal">0,00 ‚Ç¨</span>
                </div>
                <div class="total-row discount">
                    <span>Remise</span>
                    <span id="checkoutDiscount">0,00 ‚Ç¨</span>
                </div>
                <div class="total-row">
                    <span>TVA (20%)</span>
                    <span id="checkoutTax">0,00 ‚Ç¨</span>
                </div>
                <div class="summary-divider"></div>
                <div class="total-row final">
                    <span>Total</span>
                    <span id="checkoutTotal">0,00 ‚Ç¨</span>
                </div>
            </div>

            <div class="trust-badges">
                <div class="badge">
                    <span>üîí</span>
                    <span>Paiement s√©curis√©</span>
                </div>
                <div class="badge">
                    <span>‚úì</span>
                    <span>Garantie 30 jours</span>
                </div>
                <div class="badge">
                    <span>‚ö°</span>
                    <span>Acc√®s imm√©diat</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR"></script>
<script>
// ==================== CONFIGURATION ====================
const STRIPE_PUBLIC_KEY = 'pk_test_...'; // √Ä remplacer par votre cl√© publique Stripe
let currentStep = 1;
let stripe, cardElement, paymentIntentClientSecret;

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', function() {
    loadCheckoutCart();
    updateCartBadgeFromAPI(); // Synchroniser le badge panier
    initializeStripe();
    initializePayPal();
    initializePaymentMethods();
    generateBankReference();
});

// ==================== CHARGEMENT PANIER ====================
async function loadCheckoutCart() {
    try {
        const response = await fetch('/api/cart');
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error('Erreur chargement panier');
        }
        
        const data = await response.json();
        
        if (data.success && data.cart) {
            renderCheckoutItems(data.cart);
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('checkoutItems').innerHTML = 
            '<div class="error">‚ùå Erreur de chargement</div>';
    }
}

function renderCheckoutItems(cart) {
    const itemsContainer = document.getElementById('checkoutItems');
    
    if (!cart.items || cart.items.length === 0) {
        itemsContainer.innerHTML = '<div class="empty">Panier vide</div>';
        return;
    }
    
    itemsContainer.innerHTML = cart.items.map(item => `
        <div class="summary-item">
            <div class="item-info">
                <div class="item-image">
                    <div class="placeholder-image">üé®</div>
                </div>
                <div class="item-details">
                    <h4>${item.product_name || 'Produit #' + item.product_id}</h4>
                    <p>Quantit√©: ${item.quantity}</p>
                </div>
            </div>
            <div class="item-price">${(item.price_at_addition * item.quantity).toFixed(2)} ‚Ç¨</div>
        </div>
    `).join('');
    
    // Mettre √† jour les totaux
    document.getElementById('checkoutSubtotal').textContent = cart.subtotal.toFixed(2) + ' ‚Ç¨';
    document.getElementById('checkoutDiscount').textContent = '0,00 ‚Ç¨';
    document.getElementById('checkoutTax').textContent = cart.tax.toFixed(2) + ' ‚Ç¨';
    document.getElementById('checkoutTotal').textContent = cart.total.toFixed(2) + ' ‚Ç¨';
    
    // Mettre √† jour le badge panier
    updateCartBadgeFromAPI();
}

// Mettre √† jour le badge du panier depuis l'API
async function updateCartBadgeFromAPI() {
    try {
        const response = await fetch('/api/cart');
        if (response.ok) {
            const data = await response.json();
            const badge = document.getElementById('cartBadge');
            if (badge && data.success) {
                const totalItems = data.cart.total_items || 0;
                badge.textContent = totalItems;
                badge.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }
    } catch (error) {
        console.error('Erreur mise √† jour badge:', error);
    }
}

// ==================== STRIPE ====================
function initializeStripe() {
    // Initialiser Stripe
    stripe = Stripe(STRIPE_PUBLIC_KEY);
    const elements = stripe.elements();
    
    // Cr√©er l'√©l√©ment carte
    cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#1a1a2e',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
            invalid: {
                color: '#ff6b6b',
            },
        },
    });
    
    // Monter l'√©l√©ment dans le DOM
    cardElement.mount('#card-element');
    
    // G√©rer les erreurs
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });
}

async function processStripePayment() {
    showNotification('‚è≥ Traitement du paiement Stripe...', 'info');
    
    try {
        // Cr√©er l'intention de paiement
        const response = await fetch('/api/payment/stripe/create-intent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: 95.96,
                currency: 'eur',
                metadata: {
                    order_id: 'ORDER-' + Date.now()
                }
            })
        });
        
        const data = await response.json();
        paymentIntentClientSecret = data.client_secret;
        
        // Confirmer le paiement
        const result = await stripe.confirmCardPayment(paymentIntentClientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    address: {
                        line1: document.getElementById('address').value,
                        city: document.getElementById('city').value,
                        postal_code: document.getElementById('postalCode').value,
                        country: document.getElementById('country').value,
                    }
                }
            }
        });
        
        if (result.error) {
            showNotification('‚ùå ' + result.error.message, 'error');
            return false;
        } else {
            if (result.paymentIntent.status === 'succeeded') {
                showNotification('‚úì Paiement r√©ussi !', 'success');
                goToStep(3);
                return true;
            }
        }
    } catch (error) {
        showNotification('‚ùå Erreur: ' + error.message, 'error');
        return false;
    }
}

// ==================== PAYPAL ====================
function initializePayPal() {
    paypal.Buttons({
        createOrder: function(data, actions) {
            return fetch('/api/payment/paypal/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: 95.96,
                    currency: 'EUR',
                    description: 'Commande WeBox'
                })
            })
            .then(response => response.json())
            .then(data => data.order_id);
        },
        onApprove: function(data, actions) {
            showNotification('‚è≥ Finalisation du paiement PayPal...', 'info');
            
            return fetch(`/api/payment/paypal/success?paymentId=${data.orderID}&PayerID=${data.payerID}`)
                .then(response => {
                    if (response.ok) {
                        showNotification('‚úì Paiement PayPal r√©ussi !', 'success');
                        setTimeout(() => goToStep(3), 1000);
                    } else {
                        showNotification('‚ùå Erreur lors du paiement PayPal', 'error');
                    }
                });
        },
        onError: function(err) {
            showNotification('‚ùå Erreur PayPal: ' + err, 'error');
        },
        style: {
            layout: 'vertical',
            color: 'gold',
            shape: 'rect',
            label: 'paypal'
        }
    }).render('#paypal-button-container');
}

// ==================== VIREMENT BANCAIRE ====================
function generateBankReference() {
    const orderId = 'ORDER-' + Date.now();
    const reference = 'WB-' + orderId.substring(6);
    document.getElementById('bankReference').textContent = reference;
}

async function processBankTransfer() {
    showNotification('‚è≥ G√©n√©ration des informations de virement...', 'info');
    
    try {
        const response = await fetch('/api/payment/bank-transfer/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                order_id: 'ORDER-' + Date.now()
            })
        });
        
        const data = await response.json();
        
        showNotification('‚úì Informations de virement g√©n√©r√©es !', 'success');
        setTimeout(() => goToStep(3), 1000);
        return true;
    } catch (error) {
        showNotification('‚ùå Erreur: ' + error.message, 'error');
        return false;
    }
}

// ==================== NAVIGATION ====================
function goToStep(step) {
    // Validation avant de passer √† l'√©tape suivante
    if (step > currentStep) {
        if (!validateStep(currentStep)) {
            return;
        }
    }

    // Cacher toutes les sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });

    // Afficher la section demand√©e
    document.getElementById(`step${step}`).classList.add('active');

    // Mettre √† jour les √©tapes de progression
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        if (index < step) {
            stepEl.classList.add('active');
        } else {
            stepEl.classList.remove('active');
        }
    });

    currentStep = step;

    // Scroll vers le haut
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(step) {
    if (step === 1) {
        const requiredFields = ['firstName', 'lastName', 'email', 'address', 'city', 'postalCode', 'country'];
        for (const field of requiredFields) {
            const input = document.getElementById(field);
            if (!input.value.trim()) {
                showNotification(`‚ùå Veuillez remplir le champ: ${input.previousElementSibling.textContent}`, 'error');
                input.focus();
                return false;
            }
        }
    }

    return true;
}

// ==================== TRAITEMENT DU PAIEMENT ====================
async function processPayment() {
    const paymentMethod = document.querySelector('input[name="payment"]:checked').id;
    const submitBtn = document.getElementById('submitPayment');
    
    // D√©sactiver le bouton
    submitBtn.disabled = true;
    submitBtn.textContent = 'Traitement en cours...';
    
    let success = false;
    
    try {
        switch(paymentMethod) {
            case 'card':
                success = await processStripePayment();
                break;
            case 'paypal':
                showNotification('‚ÑπÔ∏è Veuillez cliquer sur le bouton PayPal ci-dessus', 'info');
                success = false;
                break;
            case 'bank':
                success = await processBankTransfer();
                break;
            default:
                showNotification('‚ùå M√©thode de paiement non valide', 'error');
        }
    } catch (error) {
        showNotification('‚ùå Erreur: ' + error.message, 'error');
    } finally {
        // R√©activer le bouton
        submitBtn.disabled = false;
        submitBtn.textContent = 'Valider le paiement';
    }
}

// ==================== GESTION DES M√âTHODES DE PAIEMENT ====================
function initializePaymentMethods() {
    // Fonction pour changer de m√©thode de paiement
    function switchPaymentMethod(methodType) {
        // Activer la m√©thode s√©lectionn√©e
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
        const selectedMethod = document.querySelector(`.payment-method[data-method="${methodType}"]`);
        if (selectedMethod) {
            selectedMethod.classList.add('active');
            selectedMethod.querySelector('input').checked = true;
        }
        
        // Afficher le formulaire correspondant
        document.querySelectorAll('.payment-form').forEach(form => form.classList.remove('active'));
        const targetForm = document.getElementById(`${methodType}Form`);
        if (targetForm) {
            targetForm.classList.add('active');
        }
        
        console.log('M√©thode de paiement s√©lectionn√©e:', methodType);
    }
    
    // Ajouter des √©v√©nements sur les conteneurs de m√©thode
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function(e) {
            const methodType = this.dataset.method;
            switchPaymentMethod(methodType);
        });
    });
    
    // Ajouter √©galement des √©v√©nements sur les inputs radio
    document.querySelectorAll('input[name="payment"]').forEach(input => {
        input.addEventListener('change', function() {
            const methodType = this.closest('.payment-method').dataset.method;
            switchPaymentMethod(methodType);
        });
    });
    
    // Ajouter des √©v√©nements sur les labels
    document.querySelectorAll('.payment-method label').forEach(label => {
        label.addEventListener('click', function(e) {
            const methodType = this.closest('.payment-method').dataset.method;
            switchPaymentMethod(methodType);
        });
    });
}

// ==================== NOTIFICATIONS ====================
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 1rem 2rem;
        background: ${type === 'success' ? '#4caf50' : type === 'info' ? '#2196f3' : '#f44336'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
