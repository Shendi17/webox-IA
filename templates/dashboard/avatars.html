{% extends "dashboard/base_dashboard.html" %}

{% block title %}üë§ Mes Avatars - WeBox{% endblock %}

{% block extra_css %}
<style>
    .avatars-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        color: #333;
    }

    .btn-create {
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: transform 0.3s;
    }

    .btn-create:hover {
        transform: translateY(-2px);
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #666;
        font-size: 0.875rem;
    }

    /* Filters */
    .filters-bar {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 0.5rem 1rem;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.875rem;
    }

    .filter-btn:hover {
        border-color: #667eea;
    }

    .filter-btn.active {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    /* Avatars Grid */
    .avatars-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 2rem;
    }

    .avatar-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }

    .avatar-card:hover {
        transform: translateY(-5px);
    }

    .avatar-image {
        width: 100%;
        aspect-ratio: 1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 5rem;
        position: relative;
        overflow: hidden;
    }

    .avatar-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-content {
        padding: 1.5rem;
    }

    .avatar-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .avatar-meta {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .avatar-tag {
        padding: 0.25rem 0.75rem;
        background: #f0f0f0;
        border-radius: 15px;
        font-size: 0.75rem;
        color: #666;
    }

    .avatar-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
        font-size: 0.875rem;
        color: #666;
    }

    .avatar-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-action {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.875rem;
    }

    .btn-download {
        background: #11998e;
        color: white;
    }

    .btn-download:hover {
        background: #0e8577;
    }

    .btn-share {
        background: #667eea;
        color: white;
    }

    .btn-share:hover {
        background: #5568d3;
    }

    .btn-delete {
        background: #ff4757;
        color: white;
    }

    .btn-delete:hover {
        background: #e63946;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 15px;
    }

    .empty-state-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-image {
        width: 100%;
        border-radius: 15px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="avatars-page">
    <div class="page-header">
        <h1>üë§ Mes Avatars</h1>
        <a href="/avatar/create" class="btn-create">+ Cr√©er un Avatar</a>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon">üë§</div>
            <div class="stat-value" id="totalAvatars">0</div>
            <div class="stat-label">Avatars cr√©√©s</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚¨áÔ∏è</div>
            <div class="stat-value" id="totalDownloads">0</div>
            <div class="stat-label">T√©l√©chargements</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üì§</div>
            <div class="stat-value" id="totalShares">0</div>
            <div class="stat-label">Partages</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üåê</div>
            <div class="stat-value" id="publicAvatars">0</div>
            <div class="stat-label">Publics</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <button class="filter-btn active" onclick="filterByStyle('all')">Tous</button>
        <button class="filter-btn" onclick="filterByStyle('realistic')">üì∏ R√©aliste</button>
        <button class="filter-btn" onclick="filterByStyle('cartoon')">üé® Cartoon</button>
        <button class="filter-btn" onclick="filterByStyle('anime')">üéå Anime</button>
        <button class="filter-btn" onclick="filterByStyle('pixel-art')">üéÆ Pixel Art</button>
        <button class="filter-btn" onclick="filterByStyle('3d')">üé¨ 3D</button>
    </div>

    <!-- Avatars Grid -->
    <div class="avatars-grid" id="avatarsGrid">
        <!-- Avatars will be loaded here -->
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">üë§</div>
        <h2>Aucun avatar pour le moment</h2>
        <p>Cr√©ez votre premier avatar avec l'IA !</p>
        <a href="/avatar/create" class="btn-create">Cr√©er mon premier avatar</a>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Avatar</h3>
            <button class="modal-close" onclick="closeModal()">‚úñÔ∏è</button>
        </div>
        <img id="modalImage" class="modal-image" src="" alt="">
        <div id="modalDetails"></div>
    </div>
</div>

<script>
    let avatars = [];
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', async function() {
        await loadStats();
        await loadAvatars();
    });

    async function loadStats() {
        try {
            const response = await fetch('/api/avatars/stats/summary');
            const data = await response.json();

            if (data.success) {
                document.getElementById('totalAvatars').textContent = data.stats.total_avatars;
                document.getElementById('totalDownloads').textContent = data.stats.total_downloads;
                document.getElementById('totalShares').textContent = data.stats.total_shares;
                document.getElementById('publicAvatars').textContent = data.stats.public_avatars;
            }
        } catch (error) {
            console.error('Erreur:', error);
        }
    }

    async function loadAvatars() {
        try {
            const response = await fetch('/api/avatars/list');
            const data = await response.json();

            if (data.success) {
                avatars = data.avatars;
                displayAvatars();
            }
        } catch (error) {
            console.error('Erreur:', error);
        }
    }

    function displayAvatars() {
        const grid = document.getElementById('avatarsGrid');
        const emptyState = document.getElementById('emptyState');

        let filteredAvatars = avatars;
        if (currentFilter !== 'all') {
            filteredAvatars = avatars.filter(a => a.style === currentFilter);
        }

        if (filteredAvatars.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        grid.style.display = 'grid';
        emptyState.style.display = 'none';

        grid.innerHTML = filteredAvatars.map(avatar => `
            <div class="avatar-card">
                <div class="avatar-image" onclick="viewAvatar(${avatar.id})">
                    ${avatar.image_url ? 
                        `<img src="${avatar.image_url}" alt="${avatar.name}">` : 
                        'üë§'
                    }
                </div>
                <div class="avatar-content">
                    <div class="avatar-name">${avatar.name}</div>
                    <div class="avatar-meta">
                        <span class="avatar-tag">${avatar.style}</span>
                        <span class="avatar-tag">${avatar.gender}</span>
                        ${avatar.category ? `<span class="avatar-tag">${avatar.category}</span>` : ''}
                    </div>
                    <div class="avatar-stats">
                        <span>‚¨áÔ∏è ${avatar.downloads_count || 0}</span>
                        <span>üì§ ${avatar.shares_count || 0}</span>
                    </div>
                    <div class="avatar-actions">
                        <button class="btn-action btn-download" onclick="downloadAvatar(${avatar.id}, '${avatar.image_url}')">
                            ‚¨áÔ∏è T√©l√©charger
                        </button>
                        <button class="btn-action btn-share" onclick="shareAvatar(${avatar.id})">
                            üì§
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteAvatar(${avatar.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function filterByStyle(style) {
        currentFilter = style;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        displayAvatars();
    }

    function viewAvatar(id) {
        const avatar = avatars.find(a => a.id === id);
        if (!avatar) return;

        document.getElementById('modalTitle').textContent = avatar.name;
        document.getElementById('modalImage').src = avatar.image_url;
        document.getElementById('modalDetails').innerHTML = `
            <p><strong>Style:</strong> ${avatar.style}</p>
            <p><strong>Genre:</strong> ${avatar.gender}</p>
            ${avatar.description ? `<p><strong>Description:</strong> ${avatar.description}</p>` : ''}
            ${avatar.prompt ? `<p><strong>Prompt:</strong> ${avatar.prompt}</p>` : ''}
        `;
        
        document.getElementById('viewModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('viewModal').classList.remove('active');
    }

    async function downloadAvatar(id, imageUrl) {
        try {
            // Increment download count
            await fetch(`/api/avatars/${id}/download`, { method: 'POST' });
            
            // Download image
            const a = document.createElement('a');
            a.href = imageUrl;
            a.download = `avatar_${id}.png`;
            a.click();

            await loadStats();
            await loadAvatars();
        } catch (error) {
            console.error('Erreur:', error);
        }
    }

    async function shareAvatar(id) {
        try {
            await fetch(`/api/avatars/${id}/share`, { method: 'POST' });
            
            const avatar = avatars.find(a => a.id === id);
            if (avatar && navigator.share) {
                await navigator.share({
                    title: avatar.name,
                    text: `D√©couvrez mon avatar cr√©√© avec WeBox IA !`,
                    url: window.location.href
                });
            } else {
                alert('‚úÖ Lien copi√© dans le presse-papier !');
            }

            await loadStats();
            await loadAvatars();
        } catch (error) {
            console.error('Erreur:', error);
        }
    }

    async function deleteAvatar(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet avatar ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/avatars/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Avatar supprim√©');
                await loadStats();
                await loadAvatars();
            } else {
                alert('‚ùå Erreur lors de la suppression');
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert('‚ùå Erreur lors de la suppression');
        }
    }
</script>
{% endblock %}
