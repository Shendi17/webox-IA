{% extends "dashboard/base_dashboard.html" %}

{% block title %}Chat Agent IA - WeBox{% endblock %}

{% block content %}
<style>
.agent-chat-container {
    display: flex;
    height: calc(100vh - 120px);
    gap: 1rem;
    padding: 1rem;
}

.agent-sidebar {
    width: 300px;
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.agent-profile {
    text-align: center;
    margin-bottom: 2rem;
}

.agent-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    margin: 0 auto 1rem;
}

.agent-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.agent-category {
    color: #667eea;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: capitalize;
}

.agent-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #f0f0f0;
}

.agent-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f0f0f0;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.stat-label {
    font-size: 0.8rem;
    color: #999;
    margin-top: 0.25rem;
}

.agent-actions {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.btn-action {
    padding: 0.75rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-config {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-config:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-clear {
    background: #f8f9fa;
    color: #666;
}

.btn-clear:hover {
    background: #e9ecef;
}

.chat-main {
    flex: 1;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 1.5rem;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #1a1a2e;
}

.chat-mode {
    padding: 0.5rem 1rem;
    background: #fff3cd;
    color: #856404;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
}

.message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.message.agent .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
}

.message-content {
    max-width: 70%;
    padding: 1rem 1.5rem;
    border-radius: 15px;
    line-height: 1.6;
}

.message.agent .message-content {
    background: #f8f9fa;
    color: #333;
}

.message.user .message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.message-time {
    font-size: 0.75rem;
    color: #999;
    margin-top: 0.5rem;
}

.chat-input-container {
    padding: 1.5rem;
    border-top: 1px solid #f0f0f0;
}

.chat-input-wrapper {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 1rem;
    resize: none;
    min-height: 60px;
    max-height: 150px;
    font-family: inherit;
}

.chat-input:focus {
    outline: none;
    border-color: #667eea;
}

.btn-send {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #1a1a2e;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
}

.btn-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #999;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-state-text {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.empty-state-hint {
    font-size: 0.9rem;
    color: #bbb;
}
</style>

<div class="agent-chat-container">
    <!-- Sidebar Agent -->
    <div class="agent-sidebar">
        <div class="agent-profile">
            <div class="agent-avatar" id="agentAvatar">ü§ñ</div>
            <div class="agent-name" id="agentName">Chargement...</div>
            <div class="agent-category" id="agentCategory"></div>
            <div class="agent-description" id="agentDescription"></div>
        </div>

        <div class="agent-stats">
            <div class="stat-item">
                <div class="stat-value" id="agentConversations">0</div>
                <div class="stat-label">Conversations</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="agentTasks">0</div>
                <div class="stat-label">T√¢ches</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="agentSatisfaction">0</div>
                <div class="stat-label">Note</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="agentModel">GPT-4</div>
                <div class="stat-label">Mod√®le</div>
            </div>
        </div>

        <div class="agent-actions">
            <button class="btn-action btn-config" onclick="configureAgent()">‚öôÔ∏è Configurer</button>
            <button class="btn-action btn-clear" onclick="clearConversation()">üóëÔ∏è Nouvelle conversation</button>
        </div>
    </div>

    <!-- Zone de chat -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-title">üí¨ Conversation</div>
            <div class="chat-mode" id="chatMode" style="display: none;">üß™ Mode Test</div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <div class="empty-state-text">Commencez une conversation</div>
                <div class="empty-state-hint">Posez une question √† votre agent IA</div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="chat-input" 
                    placeholder="√âcrivez votre message..."
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="btn-send" onclick="sendMessage()" id="sendButton">
                    üì§ Envoyer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let agentId = null;
let agentData = null;
let isTestMode = false;
let conversationId = null;

// R√©cup√©rer l'ID de l'agent depuis l'URL
function getAgentIdFromUrl() {
    const path = window.location.pathname;
    const match = path.match(/\/agent-chat\/(\d+)/);
    return match ? parseInt(match[1]) : null;
}

// V√©rifier si mode test
function checkTestMode() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('mode') === 'test';
}

// Charger les donn√©es de l'agent
async function loadAgent() {
    agentId = getAgentIdFromUrl();
    isTestMode = checkTestMode();
    
    if (!agentId) {
        alert('Agent non trouv√©');
        window.location.href = '/agents';
        return;
    }
    
    if (isTestMode) {
        document.getElementById('chatMode').style.display = 'block';
    }
    
    try {
        // Charger les agents de l'utilisateur
        const response = await fetch('/api/agents/my-agents');
        const data = await response.json();
        
        agentData = data.agents.find(a => a.id === agentId);
        
        if (!agentData) {
            alert('Agent non trouv√©');
            window.location.href = '/agents';
            return;
        }
        
        // Afficher les infos de l'agent
        document.getElementById('agentAvatar').textContent = agentData.icon || 'ü§ñ';
        document.getElementById('agentName').textContent = agentData.name;
        document.getElementById('agentCategory').textContent = agentData.category;
        document.getElementById('agentDescription').textContent = agentData.description;
        document.getElementById('agentConversations').textContent = agentData.conversations || 0;
        document.getElementById('agentTasks').textContent = agentData.tasks || 0;
        document.getElementById('agentSatisfaction').textContent = agentData.satisfaction || 0;
        document.getElementById('agentModel').textContent = agentData.model || 'GPT-4';
        
        // Charger l'historique si pas en mode test
        if (!isTestMode) {
            loadConversationHistory();
        }
        
    } catch (error) {
        console.error('Erreur chargement agent:', error);
        alert('Erreur lors du chargement de l\'agent');
    }
}

// Charger l'historique des conversations
async function loadConversationHistory() {
    // TODO: Impl√©menter le chargement de l'historique
    console.log('Chargement historique pour agent', agentId);
}

// Envoyer un message
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // D√©sactiver le bouton
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.textContent = '‚è≥ Envoi...';
    
    // Afficher le message de l'utilisateur
    addMessage('user', message);
    input.value = '';
    
    try {
        // TODO: Appeler l'API de chat avec l'agent
        // Pour l'instant, r√©ponse simul√©e
        setTimeout(() => {
            addMessage('agent', `Je suis ${agentData.name}. Je vais vous aider avec votre demande : "${message}"`);
            sendButton.disabled = false;
            sendButton.textContent = 'üì§ Envoyer';
        }, 1000);
        
    } catch (error) {
        console.error('Erreur envoi message:', error);
        alert('Erreur lors de l\'envoi du message');
        sendButton.disabled = false;
        sendButton.textContent = 'üì§ Envoyer';
    }
}

// Ajouter un message √† l'interface
function addMessage(type, content) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // Supprimer l'√©tat vide si pr√©sent
    const emptyState = messagesContainer.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const avatar = type === 'agent' ? (agentData?.icon || 'ü§ñ') : 'üë§';
    const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div>
            <div class="message-content">${content}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// G√©rer la touche Entr√©e
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// Configurer l'agent
function configureAgent() {
    window.location.href = `/agent-config/${agentId}`;
}

// Nouvelle conversation
function clearConversation() {
    if (confirm('Commencer une nouvelle conversation ?')) {
        document.getElementById('chatMessages').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <div class="empty-state-text">Commencez une conversation</div>
                <div class="empty-state-hint">Posez une question √† votre agent IA</div>
            </div>
        `;
        conversationId = null;
    }
}

// Charger au d√©marrage
document.addEventListener('DOMContentLoaded', loadAgent);
</script>
{% endblock %}
