{% extends "dashboard/base_dashboard.html" %}

{% block title %}LMS - Formations{% endblock %}

{% block extra_css %}
<style>
/* Styles sp√©cifiques LMS uniquement */
.course-price {
    font-size: 1.25rem;
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-text">
                <h1>üìö Formations LMS</h1>
                <p>Cr√©ez et g√©rez vos formations en ligne avec l'IA</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-primary" onclick="openCreateModal()">
                    + Cr√©er une formation
                </button>
                <button class="btn btn-ai" onclick="openGenerateModal()">
                    ü§ñ G√©n√©rer avec IA
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('my-courses')" data-tab="my-courses">
            Mes Formations
        </button>
        <button class="tab" onclick="switchTab('enrolled')" data-tab="enrolled">
            Mes Inscriptions
        </button>
        <button class="tab" onclick="switchTab('all')" data-tab="all">
            Toutes les Formations
        </button>
    </div>

    <!-- Contenu -->
    <div id="coursesContainer">
        <div class="loading">Chargement...</div>
    </div>
</div>

<!-- Modal Cr√©er Formation -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Cr√©er une Formation</h3>
            <button class="modal-close" onclick="closeCreateModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="createForm">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="createTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description courte</label>
                    <input type="text" id="createShortDesc" class="form-control">
                </div>
                <div class="form-group">
                    <label>Description compl√®te</label>
                    <textarea id="createDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cat√©gorie</label>
                        <select id="createCategory" class="form-control">
                            <option value="marketing">Marketing</option>
                            <option value="development">D√©veloppement</option>
                            <option value="design">Design</option>
                            <option value="business">Business</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Niveau</label>
                        <select id="createLevel" class="form-control">
                            <option value="beginner">D√©butant</option>
                            <option value="intermediate">Interm√©diaire</option>
                            <option value="advanced">Avanc√©</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeCreateModal()">Annuler</button>
            <button class="btn-primary" onclick="createCourse()">Cr√©er</button>
        </div>
    </div>
</div>

<!-- Modal G√©n√©rer avec IA -->
<div id="generateModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>ü§ñ G√©n√©rer une Formation avec IA</h3>
            <button class="modal-close" onclick="closeGenerateModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="generateForm">
                <div class="form-group">
                    <label>Sujet de la formation</label>
                    <input type="text" id="generateTitle" class="form-control" placeholder="Ex: Marketing Digital" required>
                </div>
                <div class="form-group">
                    <label>Description / Objectifs</label>
                    <textarea id="generateDescription" class="form-control" rows="3" placeholder="D√©crivez ce que les √©tudiants vont apprendre..." required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre de modules</label>
                        <select id="generateModules" class="form-control">
                            <option value="3">3 modules</option>
                            <option value="5" selected>5 modules</option>
                            <option value="8">8 modules</option>
                            <option value="10">10 modules</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="generateContent" checked>
                        G√©n√©rer le contenu des le√ßons
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="generateQuizzes" checked>
                        G√©n√©rer les quiz
                    </label>
                </div>
                <div class="alert alert-info">
                    ‚ÑπÔ∏è La g√©n√©ration peut prendre quelques minutes selon le nombre de modules.
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeGenerateModal()">Annuler</button>
            <button class="btn-primary" onclick="generateCourse()">
                ü§ñ G√©n√©rer la Formation
            </button>
        </div>
    </div>
</div>

<script>
let currentTab = 'my-courses';

// Charger les formations au d√©marrage
document.addEventListener('DOMContentLoaded', () => {
    loadCourses();
});

// Changer d'onglet
function switchTab(tab) {
    currentTab = tab;
    
    // Mettre √† jour l'UI des tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Recharger les cours
    loadCourses();
}

// Charger les formations
async function loadCourses() {
    try {
        const container = document.getElementById('coursesContainer');
        container.innerHTML = '<div class="loading"><p>‚è≥ Chargement...</p></div>';
        
        let url = '/api/lms/courses';
        
        if (currentTab === 'my-courses') {
            url += '?my_courses=true';
        } else if (currentTab === 'enrolled') {
            url = '/api/lms/my-courses';
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.courses.length > 0) {
            renderCourses(data.courses);
        } else {
            renderEmptyState();
        }
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('coursesContainer').innerHTML = 
            '<div class="empty-state"><p>‚ùå Erreur de chargement</p></div>';
    }
}

// Afficher les formations
function renderCourses(courses) {
    const html = `
        <div class="courses-grid">
            ${courses.map(course => `
                <div class="course-card" onclick="viewCourse(${course.id})">
                    <div class="course-thumbnail">
                        üìö
                    </div>
                    <div class="course-content">
                        ${course.category ? `<span class="course-category">${course.category}</span>` : ''}
                        <h3 class="course-title">${course.title}</h3>
                        <p class="course-description">${course.short_description || course.description || ''}</p>
                        <div class="course-meta">
                            <span>üìñ ${course.total_modules} modules</span>
                            <span>üìù ${course.total_lessons} le√ßons</span>
                            <span>üë• ${course.total_students} √©tudiants</span>
                        </div>
                        <div class="course-footer">
                            <div class="course-price">
                                ${course.is_free ? 'Gratuit' : `${course.price}‚Ç¨`}
                            </div>
                            <div class="course-actions" onclick="event.stopPropagation()">
                                <button class="btn-small btn-edit" onclick="editCourse(${course.id})">
                                    ‚úèÔ∏è √âditer
                                </button>
                                ${!course.is_published ? `
                                    <button class="btn-small btn-primary" onclick="publishCourse(${course.id})">
                                        üì§ Publier
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('coursesContainer').innerHTML = html;
}

// Afficher l'√©tat vide
function renderEmptyState() {
    const html = `
        <div class="empty-state">
            <div class="empty-state-icon">üìö</div>
            <h3>Aucune formation</h3>
            <p>Commencez par cr√©er votre premi√®re formation !</p>
            <button class="btn-primary" onclick="openCreateModal()">
                + Cr√©er une formation
            </button>
        </div>
    `;
    
    document.getElementById('coursesContainer').innerHTML = html;
}

// Ouvrir modal cr√©ation
function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

// Fermer modal cr√©ation
function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createForm').reset();
}

// Cr√©er une formation
async function createCourse() {
    try {
        const data = {
            title: document.getElementById('createTitle').value,
            short_description: document.getElementById('createShortDesc').value,
            description: document.getElementById('createDescription').value,
            category: document.getElementById('createCategory').value,
            level: document.getElementById('createLevel').value
        };
        
        const response = await fetch('/api/lms/courses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ Formation cr√©√©e !', 'success');
            closeCreateModal();
            loadCourses();
        } else {
            showNotification(`‚ùå ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de cr√©ation', 'error');
    }
}

// Ouvrir modal g√©n√©ration
function openGenerateModal() {
    document.getElementById('generateModal').style.display = 'flex';
}

// Fermer modal g√©n√©ration
function closeGenerateModal() {
    document.getElementById('generateModal').style.display = 'none';
    document.getElementById('generateForm').reset();
}

// G√©n√©rer une formation avec IA
async function generateCourse() {
    try {
        const data = {
            title: document.getElementById('generateTitle').value,
            description: document.getElementById('generateDescription').value,
            num_modules: parseInt(document.getElementById('generateModules').value),
            generate_content: document.getElementById('generateContent').checked,
            generate_quizzes: document.getElementById('generateQuizzes').checked
        };
        
        showNotification('‚è≥ G√©n√©ration en cours... Cela peut prendre quelques minutes.', 'info');
        closeGenerateModal();
        
        const response = await fetch('/api/lms/courses/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`‚úÖ ${result.message}`, 'success');
            loadCourses();
        } else {
            showNotification(`‚ùå ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de g√©n√©ration', 'error');
    }
}

// Voir une formation
function viewCourse(courseId) {
    window.location.href = `/lms/courses/${courseId}`;
}

// √âditer une formation
function editCourse(courseId) {
    window.location.href = `/lms/courses/${courseId}/edit`;
}

// Publier une formation
async function publishCourse(courseId) {
    if (!confirm('Voulez-vous publier cette formation ?')) return;
    
    try {
        const response = await fetch(`/api/lms/courses/${courseId}/publish`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ Formation publi√©e !', 'success');
            loadCourses();
        } else {
            showNotification(`‚ùå ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de publication', 'error');
    }
}
</script>
{% endblock %}
