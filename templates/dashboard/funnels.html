{% extends "dashboard/base_dashboard.html" %}

{% block title %}Tunnels de Vente - WeBox IA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages.css') }}">
<style>
/* ==================== MODAL CSS ==================== */
#createModal,
#generateModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 99999;
    padding: 2rem;
    overflow-y: auto;
}

#createModal.modal-open,
#generateModal.modal-open {
    display: flex;
    align-items: center;
    justify-content: center;
}

#createModal .modal-content,
#generateModal .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    position: relative;
}

#createModal .modal-header,
#generateModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

#createModal .modal-close,
#generateModal .modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #666;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
}

#createModal .modal-close:hover,
#generateModal .modal-close:hover {
    color: #000;
}
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-text">
                <h1>üéØ Tunnels de Vente</h1>
                <p>Cr√©ez des tunnels de conversion optimis√©s avec l'IA</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-ai" onclick="openGenerateModal()">
                    ü§ñ G√©n√©rer avec IA
                </button>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    + Cr√©er un tunnel
                </button>
            </div>
        </div>
    </div>

    <!-- Liste des tunnels -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">üìä Mes Tunnels</h2>
        </div>
        <div id="funnelsContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <p>Chargement des tunnels...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cr√©er Tunnel -->
<div id="createModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üéØ Cr√©er un Tunnel</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createForm" onsubmit="createFunnel(event)">
                <div class="form-group">
                    <label>Nom du tunnel *</label>
                    <input type="text" name="name" required placeholder="Mon tunnel de conversion">
                </div>
                <div class="form-group">
                    <label>Type de tunnel *</label>
                    <select name="funnel_type" required>
                        <option value="lead_magnet">üéØ Lead Magnet</option>
                        <option value="webinar">üé• Webinaire</option>
                        <option value="product">üí∞ Vente de Produit</option>
                        <option value="consultation">üí¨ Consultation</option>
                        <option value="membership">üéì Membership</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Description de votre tunnel..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">üíæ Cr√©er</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal G√©n√©rer avec IA -->
<div id="generateModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ü§ñ G√©n√©rer un Tunnel avec IA</h2>
            <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="generateForm" onsubmit="generateFunnel(event)">
                <div class="form-group">
                    <label>Type de tunnel *</label>
                    <select name="funnel_type" required>
                        <option value="lead_magnet">üéØ Lead Magnet</option>
                        <option value="webinar">üé• Webinaire</option>
                        <option value="product">üí∞ Vente de Produit</option>
                        <option value="consultation">üí¨ Consultation</option>
                        <option value="membership">üéì Membership</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sujet / Produit *</label>
                    <input type="text" name="topic" required placeholder="Formation Marketing Digital">
                </div>
                <div class="form-group">
                    <label>Audience cible *</label>
                    <input type="text" name="target_audience" required placeholder="Entrepreneurs, PME...">
                </div>
                <div class="form-group">
                    <label>Objectif principal</label>
                    <input type="text" name="goal" placeholder="G√©n√©rer des leads qualifi√©s...">
                </div>
                <div class="form-group">
                    <label>Budget estim√© (‚Ç¨)</label>
                    <input type="number" name="budget" placeholder="1000" min="0">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGenerateModal()">Annuler</button>
                    <button type="submit" class="btn btn-ai">ü§ñ G√©n√©rer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let funnels = [];

// Charger les tunnels
async function loadFunnels() {
    const container = document.getElementById('funnelsContainer');
    
    try {
        const response = await fetch('/api/marketing/funnels');
        const data = await response.json();
        
        if (data.success && data.funnels.length > 0) {
            displayFunnels(data.funnels);
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <p>Aucun tunnel de vente</p>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        + Cr√©er votre premier tunnel
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <p>Erreur lors du chargement des tunnels</p>
            </div>
        `;
    }
}

// Afficher les tunnels
function displayFunnels(funnels) {
    const container = document.getElementById('funnelsContainer');
    
    const typeIcons = {
        'lead_magnet': 'üéØ',
        'webinar': 'üé•',
        'product': 'üí∞',
        'consultation': 'üí¨',
        'membership': 'üéì'
    };

    container.innerHTML = `
        <div class="cards-grid">
            ${funnels.map(funnel => `
                <div class="card">
                    <div class="card-header">
                        <h3>${typeIcons[funnel.funnel_type] || 'üéØ'} ${funnel.name}</h3>
                        <span class="badge" style="background: ${funnel.is_active ? '#28a745' : '#ffc107'}20; color: ${funnel.is_active ? '#28a745' : '#ffc107'};">
                            ${funnel.is_active ? '‚úÖ Actif' : 'üìù Brouillon'}
                        </span>
                    </div>
                    <div class="card-body">
                        ${funnel.description ? `<p>${funnel.description}</p>` : ''}
                        <p><strong>üìä Type:</strong> ${getFunnelTypeLabel(funnel.funnel_type)}</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #667eea;">${funnel.total_visits || 0}</div>
                                <div style="font-size: 0.75rem; color: #666;">Visites</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #38ef7d;">${funnel.total_conversions || 0}</div>
                                <div style="font-size: 0.75rem; color: #666;">Conversions</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f093fb;">${((funnel.conversion_rate || 0) * 100).toFixed(1)}%</div>
                                <div style="font-size: 0.75rem; color: #666;">Taux</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="viewFunnel(${funnel.id})" style="flex: 1;">
                            üëÅÔ∏è Voir
                        </button>
                        ${!funnel.is_active ? `
                            <button class="btn btn-secondary" onclick="activateFunnel(${funnel.id})">
                                üöÄ Activer
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteFunnel(${funnel.id})">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function getFunnelTypeLabel(type) {
    const labels = {
        'lead_magnet': 'Lead Magnet',
        'webinar': 'Webinaire',
        'product': 'Vente de Produit',
        'consultation': 'Consultation',
        'membership': 'Membership'
    };
    return labels[type] || type;
}

// Cr√©er un tunnel
async function createFunnel(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    const funnelData = {
        name: formData.get('name'),
        funnel_type: formData.get('funnel_type'),
        description: formData.get('description')
    };
    
    try {
        const response = await fetch('/api/marketing/funnels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(funnelData)
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('‚úÖ Tunnel cr√©√© avec succ√®s !', 'success');
            closeCreateModal();
            form.reset();
            loadFunnels();
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur'), 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur lors de la cr√©ation', 'error');
    }
}

// G√©n√©rer un tunnel avec IA
async function generateFunnel(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    const generateData = {
        funnel_type: formData.get('funnel_type'),
        topic: formData.get('topic'),
        target_audience: formData.get('target_audience'),
        goal: formData.get('goal'),
        budget: parseFloat(formData.get('budget')) || 0
    };
    
    showNotification('ü§ñ G√©n√©ration en cours...', 'info');
    
    try {
        const response = await fetch('/api/marketing/funnels/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(generateData)
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('‚úÖ Tunnel g√©n√©r√© avec succ√®s !', 'success');
            closeGenerateModal();
            form.reset();
            loadFunnels();
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur'), 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur lors de la g√©n√©ration', 'error');
    }
}

// Voir un tunnel
function viewFunnel(id) {
    alert('Fonctionnalit√© de visualisation √† venir !\n\n- √âditeur de pages\n- Analytics d√©taill√©s\n- Gestion des automatisations');
}

// Activer un tunnel
async function activateFunnel(id) {
    if (!confirm('Activer ce tunnel ?')) return;
    
    try {
        const response = await fetch(`/api/marketing/funnels/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: true })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('‚úÖ Tunnel activ√© !', 'success');
            loadFunnels();
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur'), 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur lors de l\'activation', 'error');
    }
}

// Supprimer un tunnel
async function deleteFunnel(id) {
    if (!confirm('Supprimer ce tunnel ?')) return;
    
    try {
        const response = await fetch(`/api/marketing/funnels/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            showNotification('‚úÖ Tunnel supprim√©', 'success');
            loadFunnels();
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur'), 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur lors de la suppression', 'error');
    }
}

// Modals
function openCreateModal() {
    document.getElementById('createModal').classList.add('modal-open');
}

function closeCreateModal() {
    document.getElementById('createModal').classList.remove('modal-open');
}

function openGenerateModal() {
    document.getElementById('generateModal').classList.add('modal-open');
}

function closeGenerateModal() {
    document.getElementById('generateModal').classList.remove('modal-open');
}

// Notification
function showNotification(message, type) {
    // Ne pas afficher d'alerte pour √©viter les popups intrusifs
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadFunnels();
});
</script>
{% endblock %}
