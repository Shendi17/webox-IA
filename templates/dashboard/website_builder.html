{% extends "dashboard/base_dashboard.html" %}

{% block title %}Website Builder - WeBox{% endblock %}

{% block extra_css %}
<style>
.hero-section { background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%); color: white; padding: 3rem 2rem; border-radius: 20px; margin-bottom: 2rem; text-align: center; }
.hero-section h1 { font-size: 2.5rem; margin-bottom: 1rem; }
.hero-section p { font-size: 1.2rem; opacity: 0.9; }
.templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.template-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.3s ease; border: 3px solid transparent; }
.template-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-color: #667eea; }
.template-preview { height: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; align-items: center; justify-content: center; font-size: 4rem; }
.template-info { padding: 1.5rem; }
.template-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
.template-desc { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
.template-pages { font-size: 0.85rem; color: #667eea; }
.websites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
.website-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.website-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.website-name { font-size: 1.3rem; font-weight: 700; }
.website-status { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
.status-published { background: #28a745; color: white; }
.status-draft { background: #ffc107; color: #000; }
.website-url { color: #667eea; font-size: 0.9rem; margin-bottom: 1rem; word-break: break-all; }
.website-stats { display: flex; justify-content: space-around; padding: 1rem 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; margin-bottom: 1rem; }
.stat { text-align: center; }
.stat-value { font-size: 1.5rem; font-weight: 700; color: #667eea; }
.stat-label { font-size: 0.8rem; color: #666; }
.website-actions { display: flex; gap: 0.5rem; }
.btn-edit { background: #4169e1; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; flex: 1; }
.btn-publish { background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; flex: 1; }
.btn-delete { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; }
/* Styles modals gérés dans dashboard.css */
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
.modal-close { font-size: 2rem; cursor: pointer; color: #999; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
.form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; }
.checkbox-group { display: flex; align-items: center; gap: 0.5rem; }
.checkbox-group input[type="checkbox"] { width: auto; }
.btn-create { background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; font-size: 1.1rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>🌐 Website Builder IA</h1>
    <p>Créez un site web professionnel en quelques clics avec l'intelligence artificielle</p>
</div>

<div class="page-container">

    <!-- Templates -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">🎨 Choisissez un Template</h2>
        </div>
        <div class="templates-grid" id="templatesGrid"></div>
    </div>

    <!-- Mes Sites -->
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">🚀 Mes Sites Web</h2>
        </div>
        <div class="websites-grid" id="websitesGrid"></div>
    </div>
</div>

<!-- Modal Création -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>✨ Créer un Site Web</h2>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        
        <div class="form-group">
            <label>Nom du site</label>
            <input type="text" id="siteName" placeholder="Ex: Mon Entreprise">
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Type de site</label>
                <select id="siteType">
                    <option value="business">💼 Business</option>
                    <option value="portfolio">🎨 Portfolio</option>
                    <option value="blog">📝 Blog</option>
                    <option value="ecommerce">🛍️ E-commerce</option>
                    <option value="landing">🎯 One Page</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Secteur d'activité</label>
                <select id="industry">
                    <option value="tech">💻 Tech</option>
                    <option value="food">🍔 Food & Beverage</option>
                    <option value="fashion">👗 Fashion</option>
                    <option value="finance">💰 Finance</option>
                    <option value="health">🏥 Santé</option>
                    <option value="education">📚 Éducation</option>
                    <option value="real-estate">🏠 Immobilier</option>
                    <option value="sports">⚽ Sports</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Template</label>
            <select id="template">
                <option value="modern">✨ Moderne</option>
                <option value="classic">🏛️ Classique</option>
                <option value="minimal">⚪ Minimaliste</option>
                <option value="creative">🎨 Créatif</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" id="hasBlog">
                <span>📝 Inclure un blog</span>
            </label>
        </div>
        
        <div class="form-group">
            <label class="checkbox-group">
                <input type="checkbox" id="hasEcommerce">
                <span>🛍️ Inclure boutique e-commerce</span>
            </label>
        </div>
        
        <button class="btn-create" onclick="createWebsite()">🚀 Créer le Site (IA génère tout !)</button>
        
        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
            <strong>✨ L'IA va générer :</strong><br>
            • Structure complète du site<br>
            • Contenu rédigé pour chaque page<br>
            • Design professionnel<br>
            • Images et graphiques<br>
            • SEO optimisé
        </div>
    </div>
</div>

<script>
let templates = [];
let websites = [];

async function loadTemplates() {
    try {
        const response = await fetch('/api/websites/templates/list');
        const data = await response.json();
        if (data.success) {
            templates = data.templates;
            renderTemplates();
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function renderTemplates() {
    const grid = document.getElementById('templatesGrid');
    grid.innerHTML = templates.map(t => `
        <div class="template-card" onclick="selectTemplate('${t.id}')">
            <div class="template-preview">${t.icon}</div>
            <div class="template-info">
                <div class="template-name">${t.name}</div>
                <div class="template-desc">${t.description}</div>
                <div class="template-pages">${t.pages.length} pages incluses</div>
            </div>
        </div>
    `).join('');
}

function selectTemplate(templateId) {
    // Trouver le template sélectionné
    const template = templates.find(t => t.id === templateId);
    
    if (template) {
        // Pré-remplir le formulaire
        document.getElementById('siteName').value = `Mon ${template.name}`;
        
        // Sélectionner le type correspondant si possible
        const typeMapping = {
            'business-modern': 'business',
            'portfolio-creative': 'portfolio',
            'blog-magazine': 'blog',
            'ecommerce-shop': 'ecommerce',
            'one-page': 'landing'
        };
        
        const siteType = typeMapping[templateId] || 'business';
        document.getElementById('siteType').value = siteType;
        
        // Stocker le template sélectionné
        document.getElementById('createModal').dataset.selectedTemplate = templateId;
    }
    
    // Afficher le modal
    document.getElementById('createModal').classList.add('active');
}

function closeModal() {
    document.getElementById('createModal').classList.remove('active');
}

async function createWebsite() {
    const name = document.getElementById('siteName').value;
    
    if (!name) {
        alert('Nom du site requis');
        return;
    }
    
    try {
        const response = await fetch('/api/websites/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                site_type: document.getElementById('siteType').value,
                industry: document.getElementById('industry').value,
                template: document.getElementById('template').value,
                has_blog: document.getElementById('hasBlog').checked,
                has_ecommerce: document.getElementById('hasEcommerce').checked
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`✅ ${data.message}\n\nSubdomain: ${data.subdomain}.webox.app\nTemps estimé: ${data.estimated_time}`);
            closeModal();
            setTimeout(() => loadWebsites(), 3000);
        }
    } catch (error) {
        alert('❌ Erreur');
    }
}

async function loadWebsites() {
    try {
        const response = await fetch('/api/websites/list');
        const data = await response.json();
        if (data.success) {
            websites = data.websites;
            renderWebsites();
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function renderWebsites() {
    const grid = document.getElementById('websitesGrid');
    if (websites.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:#999;grid-column:1/-1;">Aucun site. Créez-en un à partir d\'un template !</p>';
        return;
    }
    grid.innerHTML = websites.map(w => `
        <div class="website-card">
            <div class="website-header">
                <div class="website-name">${w.name}</div>
                <span class="website-status status-${w.is_published ? 'published' : 'draft'}">
                    ${w.is_published ? '✅ Publié' : '📝 Brouillon'}
                </span>
            </div>
            <div class="website-url">
                🔗 ${w.is_published ? w.published_url : `${w.subdomain}.webox.app (brouillon)`}
            </div>
            <div style="color: #666; margin-bottom: 1rem;">
                ${getSiteTypeIcon(w.site_type)} ${w.site_type} • ${w.industry}
            </div>
            ${w.is_published ? `
                <div class="website-stats">
                    <div class="stat">
                        <div class="stat-value">${w.total_visits}</div>
                        <div class="stat-label">Visites</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${w.total_page_views}</div>
                        <div class="stat-label">Pages vues</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${w.total_conversions}</div>
                        <div class="stat-label">Conversions</div>
                    </div>
                </div>
            ` : ''}
            <div class="website-actions">
                <button class="btn-edit" onclick="editWebsite(${w.id})">✏️ Éditer</button>
                ${!w.is_published ? `
                    <button class="btn-publish" onclick="publishWebsite(${w.id})">🚀 Publier</button>
                ` : `
                    <button class="btn-publish" onclick="window.open('${w.published_url}')">👁️ Voir</button>
                `}
                <button class="btn-delete" onclick="deleteWebsite(${w.id})">🗑️</button>
            </div>
        </div>
    `).join('');
}

function getSiteTypeIcon(type) {
    const icons = {
        'business': '💼',
        'portfolio': '🎨',
        'blog': '📝',
        'ecommerce': '🛍️',
        'landing': '🎯'
    };
    return icons[type] || '🌐';
}

function editWebsite(id) {
    alert(`✏️ Éditeur de site #${id}\n\nFonctionnalités :\n- Éditeur visuel drag & drop\n- Modification sections\n- Gestion pages\n- Blog intégré\n- Analytics\n\n(En développement)`);
}

async function publishWebsite(id) {
    if (!confirm('Publier ce site maintenant ?')) return;
    
    try {
        const response = await fetch(`/api/websites/${id}/publish`, { method: 'PUT' });
        const data = await response.json();
        if (data.success) {
            alert(`✅ ${data.message}\n\nURL: ${data.url}`);
            await loadWebsites();
        }
    } catch (error) {
        alert('❌ Erreur');
    }
}

async function deleteWebsite(id) {
    if (!confirm('Supprimer ce site ? Cette action est irréversible.')) return;
    
    try {
        const response = await fetch(`/api/websites/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            alert('✅ Site supprimé');
            await loadWebsites();
        }
    } catch (error) {
        alert('❌ Erreur');
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadTemplates();
    await loadWebsites();
});

// Fermer modal en cliquant à l'extérieur
window.onclick = function(event) {
    const modal = document.getElementById('createModal');
    if (event.target == modal) {
        closeModal();
    }
}
</script>
{% endblock %}
