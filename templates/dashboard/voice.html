{% extends "dashboard/base_dashboard.html" %}

{% block title %}Assistant Vocal - WeBox{% endblock %}

{% block extra_css %}
<style>
* { pointer-events: auto !important; }

.tabs-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e0e0e0;
}

.tab-btn {
    padding: 1rem 2rem;
    border: none;
    background: none;
    font-weight: 600;
    color: #666;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
}

.tab-btn.active {
    color: #4169e1;
    border-bottom-color: #4169e1;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: #4169e1;
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

.assistants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.assistant-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.assistant-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.assistant-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.assistant-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.assistant-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.assistant-phone {
    color: #4169e1;
    font-weight: 600;
    margin-bottom: 1rem;
}

.assistant-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin: 1rem 0;
    padding: 1rem 0;
    border-top: 1px solid #e0e0e0;
    border-bottom: 1px solid #e0e0e0;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4169e1;
}

.stat-label {
    font-size: 0.85rem;
    color: #999;
}

.assistant-actions {
    display: flex;
    gap: 0.5rem;
}

.calls-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.calls-table th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #1a1a2e;
    border-bottom: 2px solid #e0e0e0;
}

.calls-table td {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.call-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-in-progress {
    background: #fff3cd;
    color: #856404;
}

.status-failed {
    background: #f8d7da;
    color: #721c24;
}

.toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    z-index: 10001;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.toast.success { border-left: 4px solid #28a745; }
.toast.error { border-left: 4px solid #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìû Assistant Vocal</h1>
    <p>Cr√©ez et g√©rez vos assistants vocaux IA pour vos clients</p>
</div>

<div class="tabs-container">
    <button class="tab-btn active" data-tab="overview">üìä Vue d'ensemble</button>
    <button class="tab-btn" data-tab="assistants">ü§ñ Mes Assistants</button>
    <button class="tab-btn" data-tab="create">‚ûï Cr√©er un Assistant</button>
    <button class="tab-btn" data-tab="calls">üìû Historique des Appels</button>
</div>

<!-- TAB: Vue d'ensemble -->
<div class="tab-content active" id="tab-overview">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="dashboard-card" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">ü§ñ</div>
            <div style="font-size: 2rem; font-weight: bold; color: #4169e1; margin-bottom: 0.5rem;" id="totalAssistants">0</div>
            <div style="color: #666;">Assistants actifs</div>
        </div>
        <div class="dashboard-card" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìû</div>
            <div style="font-size: 2rem; font-weight: bold; color: #28a745; margin-bottom: 0.5rem;" id="totalCalls">0</div>
            <div style="color: #666;">Appels ce mois</div>
        </div>
        <div class="dashboard-card" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚è±Ô∏è</div>
            <div style="font-size: 2rem; font-weight: bold; color: #ffc107; margin-bottom: 0.5rem;" id="avgDuration">0 min</div>
            <div style="color: #666;">Dur√©e moyenne</div>
        </div>
        <div class="dashboard-card" style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚≠ê</div>
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545; margin-bottom: 0.5rem;" id="avgSatisfaction">0/5</div>
            <div style="color: #666;">Satisfaction</div>
        </div>
    </div>

    <!-- Architecture du syst√®me -->
    <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">üèóÔ∏è Architecture du Syst√®me</h2>
        <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 10px; font-family: monospace; line-height: 2;">
            <div style="text-align: center;">
                <div>üì± <strong>Client appelle</strong> ‚Üí +33 1 23 45 67 89</div>
                <div style="margin: 0.5rem 0;">‚Üì</div>
                <div>‚òÅÔ∏è <strong>Twilio</strong> (R√©ception de l'appel)</div>
                <div style="margin: 0.5rem 0;">‚Üì</div>
                <div>üé§ <strong>Speech-to-Text</strong> (Google Cloud / Whisper)</div>
                <div style="margin: 0.5rem 0;">‚Üì</div>
                <div>üß† <strong>IA WeBox</strong> (GPT-4 / Claude + Contexte client)</div>
                <div style="margin: 0.5rem 0;">‚Üì</div>
                <div>üîä <strong>Text-to-Speech</strong> (ElevenLabs / Google TTS)</div>
                <div style="margin: 0.5rem 0;">‚Üì</div>
                <div>üìû <strong>Twilio</strong> ‚Üí R√©ponse vocale au client</div>
            </div>
        </div>
    </div>

    <!-- Cas d'usage -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üçΩÔ∏è</div>
            <h3>Restaurants</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                Prise de r√©servations automatique 24/7, informations sur le menu, horaires d'ouverture.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "Bonjour, je voudrais r√©server pour 4 personnes ce soir √† 20h"
            </div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üè•</div>
            <h3>Cabinets M√©dicaux</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                Prise de rendez-vous, rappels, informations pratiques, urgences.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "Je souhaite prendre rendez-vous avec le Dr. Martin pour un contr√¥le"
            </div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üè™</div>
            <h3>E-commerce</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                Suivi de commande, retours, questions produits, support client.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "O√π en est ma commande num√©ro 12345 ?"
            </div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üè¢</div>
            <h3>Entreprises B2B</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                Qualification de leads, prise de RDV commerciaux, support technique.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "Je voudrais une d√©mo de votre solution CRM"
            </div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üè®</div>
            <h3>H√¥tels</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                R√©servations, disponibilit√©s, services, informations touristiques.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "Avez-vous une chambre double disponible du 15 au 20 juin ?"
            </div>
        </div>

        <div class="dashboard-card">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üöó</div>
            <h3>Services Auto</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                Prise de RDV r√©vision, d√©pannage, devis, informations techniques.
            </p>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <strong>Exemple :</strong><br>
                "Je voudrais prendre RDV pour une r√©vision de ma Peugeot 308"
            </div>
        </div>
    </div>

    <!-- Tarification -->
    <div class="dashboard-card">
        <h2 style="margin-bottom: 1.5rem;">üí∞ Tarification Estim√©e</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px;">
                <h3 style="color: #4169e1; margin-bottom: 1rem;">Co√ªts par Appel</h3>
                <div style="line-height: 2;">
                    <div>üìû Twilio : <strong>~0.02‚Ç¨</strong></div>
                    <div>üé§ STT : <strong>~0.01‚Ç¨</strong></div>
                    <div>üß† IA (GPT-4) : <strong>~0.05‚Ç¨</strong></div>
                    <div>üîä TTS : <strong>~0.02‚Ç¨</strong></div>
                    <hr style="margin: 0.5rem 0;">
                    <div style="font-size: 1.25rem; color: #28a745;"><strong>Total : ~0.10‚Ç¨</strong></div>
                    <div style="font-size: 0.85rem; color: #999;">pour 5 minutes d'appel</div>
                </div>
            </div>

            <div style="background: #e3f2fd; padding: 1.5rem; border-radius: 10px;">
                <h3 style="color: #2196f3; margin-bottom: 1rem;">Tarif Client Sugg√©r√©</h3>
                <div style="line-height: 2;">
                    <div>üì¶ Starter : <strong>50‚Ç¨/mois</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">100 appels inclus</div>
                    <div style="margin-top: 0.5rem;">üöÄ Pro : <strong>150‚Ç¨/mois</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">500 appels inclus</div>
                    <div style="margin-top: 0.5rem;">‚≠ê Enterprise : <strong>500‚Ç¨/mois</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">Appels illimit√©s</div>
                </div>
            </div>

            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px;">
                <h3 style="color: #ffc107; margin-bottom: 1rem;">ROI Client</h3>
                <div style="line-height: 2;">
                    <div>üíº √âconomie : <strong>~2000‚Ç¨/mois</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">vs employ√© temps plein</div>
                    <div style="margin-top: 0.5rem;">‚è∞ Disponibilit√© : <strong>24/7</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">Pas de cong√©s, pas de pause</div>
                    <div style="margin-top: 0.5rem;">üìà Satisfaction : <strong>+30%</strong></div>
                    <div style="font-size: 0.85rem; color: #666;">R√©ponse imm√©diate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide d'int√©gration -->
    <div class="dashboard-card" style="margin-top: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">üìö Guide d'Int√©gration Twilio</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div>
                <h3 style="color: #4169e1; margin-bottom: 1rem;">1Ô∏è‚É£ Cr√©er un compte Twilio</h3>
                <ol style="line-height: 2; color: #666;">
                    <li>Aller sur <a href="https://www.twilio.com" target="_blank" style="color: #4169e1;">twilio.com</a></li>
                    <li>S'inscrire (essai gratuit avec 15$ de cr√©dit)</li>
                    <li>V√©rifier votre email et t√©l√©phone</li>
                </ol>
            </div>

            <div>
                <h3 style="color: #4169e1; margin-bottom: 1rem;">2Ô∏è‚É£ Acheter un num√©ro</h3>
                <ol style="line-height: 2; color: #666;">
                    <li>Console Twilio ‚Üí Phone Numbers</li>
                    <li>Buy a Number ‚Üí Choisir pays (France)</li>
                    <li>S√©lectionner "Voice" capability</li>
                    <li>Co√ªt : ~1‚Ç¨/mois</li>
                </ol>
            </div>

            <div>
                <h3 style="color: #4169e1; margin-bottom: 1rem;">3Ô∏è‚É£ Configurer les Webhooks</h3>
                <ol style="line-height: 2; color: #666;">
                    <li>S√©lectionner votre num√©ro</li>
                    <li>Voice & Fax ‚Üí Configure</li>
                    <li>A Call Comes In ‚Üí Webhook</li>
                    <li>URL : <code style="background: #f8f9fa; padding: 0.25rem;">https://votre-domaine.com/api/voice/webhook/incoming</code></li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Technologies utilis√©es -->
    <div class="dashboard-card" style="margin-top: 2rem; background: #f8f9fa;">
        <h2 style="margin-bottom: 1.5rem;">üõ†Ô∏è Stack Technologique</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚òÅÔ∏è</div>
                <strong>Twilio</strong>
                <div style="font-size: 0.85rem; color: #666;">T√©l√©phonie cloud</div>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üé§</div>
                <strong>Google STT</strong>
                <div style="font-size: 0.85rem; color: #666;">Reconnaissance vocale</div>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üß†</div>
                <strong>GPT-4 / Claude</strong>
                <div style="font-size: 0.85rem; color: #666;">Intelligence artificielle</div>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîä</div>
                <strong>ElevenLabs</strong>
                <div style="font-size: 0.85rem; color: #666;">Synth√®se vocale</div>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                <strong>FastAPI</strong>
                <div style="font-size: 0.85rem; color: #666;">Backend Python</div>
            </div>
            <div style="text-align: center; padding: 1rem;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíæ</div>
                <strong>PostgreSQL</strong>
                <div style="font-size: 0.85rem; color: #666;">Base de donn√©es</div>
            </div>
        </div>
    </div>
</div>

<!-- TAB: Mes Assistants -->
<div class="tab-content" id="tab-assistants">
    <div class="assistants-grid" id="assistantsGrid">
        <!-- Les assistants seront charg√©s ici -->
    </div>
</div>

<!-- TAB: Cr√©er un Assistant -->
<div class="tab-content" id="tab-create">
    <div class="dashboard-card" style="max-width: 800px; margin: 0 auto;">
        <h2 style="margin-bottom: 2rem;">‚ûï Cr√©er un Nouvel Assistant Vocal</h2>
        
        <form id="createAssistantForm">
            <div class="form-group">
                <label class="form-label">Nom du Client / Entreprise *</label>
                <input type="text" class="form-input" id="clientName" required placeholder="Ex: Restaurant Le Gourmet">
            </div>

            <div class="form-group">
                <label class="form-label">Email du Client</label>
                <input type="email" class="form-input" id="clientEmail" placeholder="contact@client.com">
            </div>

            <div class="form-group">
                <label class="form-label">Num√©ro Twilio *</label>
                <input type="text" class="form-input" id="twilioPhone" required placeholder="+33 1 23 45 67 89">
                <small style="color: #666;">Le num√©ro de t√©l√©phone que vos clients appelleront</small>
            </div>

            <div class="form-group">
                <label class="form-label">Mod√®le IA *</label>
                <select class="form-select" id="aiModel">
                    <option value="gpt-4">GPT-4 (OpenAI) - Recommand√©</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (OpenAI) - Rapide</option>
                    <option value="claude-3">Claude 3 (Anthropic)</option>
                    <option value="gemini-pro">Gemini Pro (Google)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Contexte / Instructions pour l'IA *</label>
                <textarea class="form-textarea" id="aiContext" required placeholder="Ex: Tu es l'assistant vocal du restaurant Le Gourmet. Tu peux prendre des r√©servations, donner les horaires d'ouverture (12h-14h et 19h-23h), et r√©pondre aux questions sur le menu. Sois professionnel et chaleureux."></textarea>
                <small style="color: #666;">D√©crivez le r√¥le et les capacit√©s de l'assistant</small>
            </div>

            <div class="form-group">
                <label class="form-label">Personnalit√© *</label>
                <select class="form-select" id="aiPersonality">
                    <option value="professional">Professionnel</option>
                    <option value="friendly">Amical</option>
                    <option value="casual">D√©contract√©</option>
                    <option value="formal">Formel</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Fournisseur de Voix *</label>
                <select class="form-select" id="voiceProvider">
                    <option value="elevenlabs">ElevenLabs (Tr√®s naturel)</option>
                    <option value="google">Google TTS (Fiable)</option>
                    <option value="azure">Azure TTS (Microsoft)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Langue *</label>
                <select class="form-select" id="voiceLanguage">
                    <option value="fr-FR">Fran√ßais</option>
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="es-ES">Espa√±ol</option>
                    <option value="de-DE">Deutsch</option>
                </select>
            </div>

            <button type="submit" class="sidebar-btn primary" style="width: 100%;">üöÄ Cr√©er l'Assistant</button>
        </form>
    </div>
</div>

<!-- TAB: Historique des Appels -->
<div class="tab-content" id="tab-calls">
    <div class="dashboard-card">
        <h2 style="margin-bottom: 1.5rem;">üìû Historique des Appels</h2>
        <div style="overflow-x: auto;">
            <table class="calls-table" id="callsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Assistant</th>
                        <th>De</th>
                        <th>Dur√©e</th>
                        <th>Statut</th>
                        <th>Satisfaction</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les appels seront charg√©s ici -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ========== SYST√àME D'ASSISTANTS VOCAUX ==========

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span style="font-size: 1.5rem;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Gestion des tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        
        // Charger les donn√©es selon l'onglet
        if (btn.dataset.tab === 'assistants') {
            loadAssistants();
        } else if (btn.dataset.tab === 'calls') {
            loadCalls();
        }
    });
});

// Charger les statistiques
async function loadStats() {
    try {
        const response = await fetch('/api/voice/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('totalCalls').textContent = stats.total_calls;
            document.getElementById('avgDuration').textContent = Math.round(stats.average_duration / 60) + ' min';
            document.getElementById('avgSatisfaction').textContent = stats.average_satisfaction.toFixed(1) + '/5';
        }
    } catch (error) {
        console.error('Erreur stats:', error);
    }
}

// Charger les assistants
async function loadAssistants() {
    try {
        const response = await fetch('/api/voice/assistants');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalAssistants').textContent = data.assistants.length;
            displayAssistants(data.assistants);
        }
    } catch (error) {
        console.error('Erreur assistants:', error);
        showToast('Erreur lors du chargement des assistants', 'error');
    }
}

// Afficher les assistants
function displayAssistants(assistants) {
    const grid = document.getElementById('assistantsGrid');
    
    if (assistants.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Aucun assistant cr√©√©. Cr√©ez-en un dans l\'onglet "Cr√©er un Assistant".</p>';
        return;
    }
    
    grid.innerHTML = assistants.map(a => `
        <div class="assistant-card">
            <div class="assistant-header">
                <div>
                    <div class="assistant-name">${a.client_name}</div>
                    <div class="assistant-phone">üìû ${a.twilio_phone_number}</div>
                </div>
                <div class="assistant-status ${a.is_active ? 'status-active' : 'status-inactive'}">
                    ${a.is_active ? '‚úì Actif' : '‚è∏ Inactif'}
                </div>
            </div>
            <div style="color: #666; margin-bottom: 1rem;">
                <div>ü§ñ ${a.ai_model}</div>
                <div>üó£Ô∏è ${a.voice_provider} (${a.voice_language})</div>
            </div>
            <div class="assistant-stats">
                <div class="stat-item">
                    <div class="stat-value">${a.total_calls}</div>
                    <div class="stat-label">Appels</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${Math.round(a.total_duration / 60)}m</div>
                    <div class="stat-label">Dur√©e</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${a.average_satisfaction.toFixed(1)}</div>
                    <div class="stat-label">Note</div>
                </div>
            </div>
            <div class="assistant-actions">
                <button class="sidebar-btn" style="flex: 1;" onclick="viewAssistant(${a.id})">üëÅÔ∏è Voir</button>
                <button class="sidebar-btn" style="flex: 1; background: #dc3545; color: white;" onclick="deleteAssistant(${a.id})">üóëÔ∏è Supprimer</button>
            </div>
        </div>
    `).join('');
}

// Cr√©er un assistant
document.getElementById('createAssistantForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        client_name: document.getElementById('clientName').value,
        client_email: document.getElementById('clientEmail').value,
        twilio_phone_number: document.getElementById('twilioPhone').value,
        ai_model: document.getElementById('aiModel').value,
        ai_context: document.getElementById('aiContext').value,
        ai_personality: document.getElementById('aiPersonality').value,
        voice_provider: document.getElementById('voiceProvider').value,
        voice_language: document.getElementById('voiceLanguage').value
    };
    
    try {
        const response = await fetch('/api/voice/assistants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Assistant cr√©√© avec succ√®s !', 'success');
            document.getElementById('createAssistantForm').reset();
            
            // Basculer vers l'onglet assistants
            document.querySelector('[data-tab="assistants"]').click();
        } else {
            showToast(result.detail || 'Erreur lors de la cr√©ation', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la cr√©ation', 'error');
    }
});

// Charger les appels
async function loadCalls() {
    try {
        const response = await fetch('/api/voice/calls?limit=50');
        const data = await response.json();
        
        if (data.success) {
            displayCalls(data.calls);
        }
    } catch (error) {
        console.error('Erreur appels:', error);
    }
}

// Afficher les appels
function displayCalls(calls) {
    const tbody = document.querySelector('#callsTable tbody');
    
    if (calls.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 2rem;">Aucun appel enregistr√©</td></tr>';
        return;
    }
    
    tbody.innerHTML = calls.map(call => `
        <tr>
            <td>${new Date(call.started_at).toLocaleString('fr-FR')}</td>
            <td>Assistant #${call.assistant_id}</td>
            <td>${call.from_number}</td>
            <td>${Math.round(call.duration / 60)} min</td>
            <td><span class="call-status status-${call.status}">${call.status}</span></td>
            <td>${call.satisfaction_score ? call.satisfaction_score.toFixed(1) + '/5' : '-'}</td>
        </tr>
    `).join('');
}

// Voir un assistant
function viewAssistant(id) {
    alert(`üëÅÔ∏è D√©tails de l'assistant #${id}\n\nFonctionnalit√© en d√©veloppement.\nBient√¥t vous pourrez voir tous les d√©tails et modifier la configuration.`);
}

// Supprimer un assistant
async function deleteAssistant(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet assistant ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/voice/assistants/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Assistant supprim√© avec succ√®s', 'success');
            loadAssistants();
            loadStats();
        } else {
            showToast('Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la suppression', 'error');
    }
}

// Init
document.addEventListener('DOMContentLoaded', () => {    loadStats();
    loadAssistants();
});</script>
{% endblock %}
