{% extends "dashboard/base_dashboard.html" %}

{% block title %}Chat Multi-IA - WeBox{% endblock %}

{% block extra_css %}
<style>
    .chat-layout {
        display: grid;
        grid-template-columns: 280px 1fr 320px;
        gap: 1.5rem;
        height: calc(100vh - 200px);
    }
    
    .chat-sidebar, .chat-right-panel {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }
    
    .new-chat-btn {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #1a1a2e;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 1rem;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }
    
    .chat-history {
        list-style: none;
        padding: 0;
    }
    
    .chat-history-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .chat-history-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }
    
    .chat-history-item.active {
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
    }
    
    .history-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .history-time {
        font-size: 0.8rem;
        color: #666;
    }
    
    .chat-history-item.active .history-time {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .chat-main {
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .chat-header {
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
        border-radius: 15px 15px 0 0;
    }
    
    /* Sélecteur d'IA actives */
    .active-ai-selector {
        padding: 1rem 2rem;
        background: #f8f9fa;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .ai-filter-btn {
        padding: 0.6rem 1.2rem;
        background: white;
        border: 2px solid #e0e0e0;
        color: #1a1a2e;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .ai-filter-btn:hover {
        background: #f8f9fa;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
    }
    
    .ai-filter-btn.active {
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
        border-color: #0f3460;
        box-shadow: 0 4px 12px rgba(15, 52, 96, 0.3);
    }
    
    .ai-filter-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        background: #f8f9fa;
    }
    
    .message {
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
    }
    
    .message.ai .message-avatar {
        background: #e9ecef;
    }
    
    .message-content {
        max-width: 70%;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        line-height: 1.6;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
    }
    
    .message.ai .message-content {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chat-input-container {
        padding: 1.5rem 2rem;
        background: white;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 15px 15px;
    }
    
    .chat-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        resize: none;
        font-family: inherit;
        font-size: 1rem;
        min-height: 60px;
        max-height: 150px;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .send-btn {
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Suggestions Panel */
    .suggestions-section {
        margin-bottom: 2rem;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 1rem;
    }
    
    .suggestion-card {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .suggestion-card:hover {
        background: white;
        border-color: #667eea;
        transform: translateX(5px);
    }
    
    .suggestion-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .suggestion-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
    }
    
    .suggestion-desc {
        font-size: 0.85rem;
        color: #666;
    }
    
    /* Templates */
    .template-card {
        padding: 1rem;
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        color: white;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .template-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .template-title {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .template-prompt {
        font-size: 0.85rem;
        opacity: 0.9;
        font-style: italic;
    }
    
    .message-hint {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .new-chat-btn.danger {
        background: #dc3545;
    }
    
    .new-chat-btn.danger:hover {
        background: #c82333;
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }
    
    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    /* Styles pour la section Sélection des IA */
    .ai-selection-section {
        margin-bottom: 2rem;
    }

    .ai-selection-section .expander {
        background: rgba(15, 52, 96, 0.05);
        border: 1px solid rgba(65, 105, 225, 0.3);
        border-radius: 10px;
        margin-bottom: 0.5rem;
        overflow: hidden;
    }

    .ai-selection-section .expander summary {
        color: #1a1a2e;
        font-weight: 600;
        padding: 0.8rem 1rem;
        cursor: pointer;
        list-style: none;
        transition: all 0.3s ease;
    }

    .ai-selection-section .expander summary::-webkit-details-marker {
        display: none;
    }

    .ai-selection-section .expander summary:hover {
        background: rgba(65, 105, 225, 0.1);
    }

    .ai-selection-section .expander[open] summary {
        background: rgba(65, 105, 225, 0.15);
        color: #4169e1;
    }

    .ai-selection-section .expander-content {
        padding: 1rem;
        background: rgba(0, 0, 0, 0.02);
    }

    .ai-selection-section .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        color: #1a1a2e;
        cursor: pointer;
    }

    .ai-selection-section .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .ai-selection-section .checkbox-item:hover {
        color: #4169e1;
    }

    .ai-selection-section .input-field,
    .ai-selection-section .slider {
        width: 100%;
        padding: 0.5rem;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #4169e1;
        border-radius: 5px;
        background: #ffffff;
        color: #000000;
    }

    .ai-selection-section .expander-content label {
        color: #1a1a2e;
        display: block;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    @media (max-width: 1200px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
        
        .chat-sidebar, .chat-right-panel {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>💬 Chat Multi-IA</h1>
    <p>Dialoguez avec GPT-4, Claude 3.5 et Gemini 2.0 Flash</p>
</div>

<div class="chat-layout">
    <!-- Left Sidebar: History -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h2>💬 Conversations</h2>
            <button class="new-chat-btn" onclick="newChat()">
                ➕ Nouvelle conversation
            </button>
        </div>
        
        <ul class="chat-history" id="chatHistory">
            <li class="chat-history-item active">
                <div class="history-title">Conversation actuelle</div>
                <div class="history-time">Il y a quelques instants</div>
            </li>
            <li class="chat-history-item">
                <div class="history-title">Marketing digital</div>
                <div class="history-time">Il y a 2 heures</div>
            </li>
            <li class="chat-history-item">
                <div class="history-title">Stratégie contenu</div>
                <div class="history-time">Hier</div>
            </li>
            <li class="chat-history-item">
                <div class="history-title">Code Python</div>
                <div class="history-time">Il y a 2 jours</div>
            </li>
        </ul>
    </div>
    
    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-header">
            <h1>💬 Chat Multi-IA</h1>
            <p style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem;">Sélectionnez les IA à droite, puis cliquez sur une IA ci-dessous pour voir sa réponse</p>
        </div>
        
        <!-- Sélecteur d'IA actives (basé sur les checkboxes) -->
        <div class="active-ai-selector" id="activeAiSelector">
            <button class="ai-filter-btn active" data-provider="all" onclick="filterByAI('all')">
                🌐 Toutes les réponses
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <strong>Gemini 2.0 Flash</strong>
                    <p>Bonjour ! Je suis votre assistant IA. Comment puis-je vous aider aujourd'hui ?</p>
                    <p class="message-hint">💡 Utilisez les suggestions à droite pour commencer rapidement !</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Tapez votre message... (Shift+Enter pour nouvelle ligne)"
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    📤 Envoyer
                </button>
            </div>
        </div>
    </div>
    
    <!-- Right Panel: Suggestions & Templates -->
    <div class="chat-right-panel">
        <!-- Sélection des IA -->
        <div class="ai-selection-section">
            <div class="section-title">🤖 Sélection des IA</div>
            
            <details class="expander" open>
                <summary>💬 Texte & Conversation</summary>
                <div class="expander-content">
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="gpt4" checked>
                        <span>GPT-4 (OpenAI)</span>
                        <select id="openai-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="GPT-5.2 (Dernière version) 🌟">
                                <option value="gpt-5.2">GPT-5.2 🚀 - Meilleure performance</option>
                                <option value="gpt-5.2-pro">GPT-5.2 Pro - Ultra puissant</option>
                                <option value="gpt-5.2-codex">GPT-5.2 Codex - Code expert</option>
                            </optgroup>
                            <optgroup label="GPT-5.1">
                                <option value="gpt-5.1">GPT-5.1</option>
                                <option value="gpt-5.1-codex">GPT-5.1 Codex</option>
                                <option value="gpt-5.1-codex-max">GPT-5.1 Codex Max</option>
                            </optgroup>
                            <optgroup label="GPT-5">
                                <option value="gpt-5">GPT-5</option>
                                <option value="gpt-5-pro">GPT-5 Pro</option>
                                <option value="gpt-5-mini">GPT-5 Mini</option>
                                <option value="gpt-5-nano">GPT-5 Nano</option>
                                <option value="gpt-5-codex">GPT-5 Codex</option>
                            </optgroup>
                            <optgroup label="GPT-4.1">
                                <option value="gpt-4.1">GPT-4.1</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            </optgroup>
                            <optgroup label="GPT-4o (Recommandé)">
                                <option value="gpt-4o" selected>GPT-4o ⚡ - Rapide et puissant</option>
                                <option value="gpt-4o-mini">GPT-4o Mini - Économique</option>
                                <option value="chatgpt-4o-latest">ChatGPT-4o Latest</option>
                            </optgroup>
                            <optgroup label="GPT-4">
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4">GPT-4 - Classique</option>
                            </optgroup>
                            <optgroup label="GPT-3.5 (Économique)">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16k</option>
                            </optgroup>
                            <optgroup label="Spécialisés">
                                <option value="gpt-4o-audio-preview">GPT-4o Audio 🎙️</option>
                                <option value="gpt-4o-search-preview">GPT-4o Search 🔍</option>
                                <option value="gpt-5-search-api">GPT-5 Search API 🔍</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="claude">
                        <span>Claude 3.5 (Anthropic)</span>
                        <select id="claude-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Claude 3.5 (Dernière génération) 🌟">
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet v2 - Le plus puissant</option>
                                <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet v1</option>
                                <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku - Rapide ⚡</option>
                            </optgroup>
                            <optgroup label="Claude 3">
                                <option value="claude-3-opus-20240229">Claude 3 Opus - Ultra puissant</option>
                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet - Équilibré</option>
                                <option value="claude-3-haiku-20240307" selected>Claude 3 Haiku - Rapide et économique ✅</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="gemini" checked>
                        <span>Gemini (Google Vertex AI)</span>
                        <select id="gemini-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Gemini 2.5 (Disponible)">
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash ⚡</option>
                                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                                <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image 🎨</option>
                            </optgroup>
                            <optgroup label="Gemini 2.0 (Disponible)">
                                <option value="gemini-2.0-flash-001">Gemini 2.0 Flash</option>
                                <option value="gemini-2.0-flash-lite-001">Gemini 2.0 Flash Lite</option>
                            </optgroup>
                            <optgroup label="Gemini 3 (Preview)">
                                <option value="gemini-3-pro">Gemini 3 Pro 🔬</option>
                                <option value="gemini-3-flash">Gemini 3 Flash 🔬</option>
                                <option value="gemini-3-pro-image">Gemini 3 Pro Image 🔬</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="mistral">
                        <span>Mistral AI</span>
                        <select id="mistral-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Mistral Large (Puissant) 🌟">
                                <option value="mistral-large-latest" selected>Mistral Large Latest - Le plus puissant</option>
                                <option value="mistral-large-2512">Mistral Large 2512</option>
                                <option value="pixtral-large-latest">Pixtral Large Latest - Vision 🎨</option>
                            </optgroup>
                            <optgroup label="Mistral Medium">
                                <option value="mistral-medium-latest">Mistral Medium Latest</option>
                                <option value="magistral-medium-latest">Magistral Medium Latest</option>
                            </optgroup>
                            <optgroup label="Mistral Small (Rapide) ⚡">
                                <option value="mistral-small-latest">Mistral Small Latest</option>
                                <option value="mistral-small-2501">Mistral Small 2501</option>
                            </optgroup>
                            <optgroup label="Codestral (Code) 💻">
                                <option value="codestral-latest">Codestral Latest - Expert en code</option>
                                <option value="codestral-2501">Codestral 2501</option>
                            </optgroup>
                            <optgroup label="Ministral (Compact)">
                                <option value="ministral-8b-latest">Ministral 8B Latest</option>
                                <option value="ministral-3b-latest">Ministral 3B Latest</option>
                            </optgroup>
                        </select>
                    </label>
                </div>
            </details>
            
            <details class="expander">
                <summary>🔤 Modèles Spécialisés</summary>
                <div class="expander-content">
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="groq">
                        <span>Groq (Ultra-rapide)</span>
                        <select id="groq-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Llama (Meta) 🦙">
                                <option value="llama-3.3-70b-versatile" selected>Llama 3.3 70B - Le plus puissant ⭐</option>
                                <option value="llama-3.1-8b-instant">Llama 3.1 8B - Ultra rapide ⚡</option>
                                <option value="meta-llama/llama-4-maverick-17b-128e-instruct">Llama 4 Maverick 17B</option>
                                <option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout 17B</option>
                            </optgroup>
                            <optgroup label="Qwen">
                                <option value="qwen/qwen3-32b">Qwen 3 32B</option>
                            </optgroup>
                            <optgroup label="OpenAI OSS">
                                <option value="openai/gpt-oss-120b">GPT OSS 120B</option>
                                <option value="openai/gpt-oss-20b">GPT OSS 20B</option>
                            </optgroup>
                            <optgroup label="Autres">
                                <option value="groq/compound">Groq Compound</option>
                                <option value="groq/compound-mini">Groq Compound Mini</option>
                                <option value="moonshotai/kimi-k2-instruct">Kimi K2 Instruct</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="deepseek">
                        <span>DeepSeek</span>
                        <select id="deepseek-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="DeepSeek Chat">
                                <option value="deepseek-chat" selected>DeepSeek Chat - Équilibré ⭐</option>
                            </optgroup>
                            <optgroup label="DeepSeek Reasoner">
                                <option value="deepseek-reasoner">DeepSeek Reasoner - Raisonnement avancé 🧠</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="perplexity">
                        <span>Perplexity (Recherche)</span>
                        <select id="perplexity-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Sonar (Recherche en ligne) 🔍">
                                <option value="sonar" selected>Sonar - Recherche standard ⭐</option>
                                <option value="sonar-pro">Sonar Pro - Recherche avancée</option>
                                <option value="sonar-reasoning">Sonar Reasoning - Raisonnement avec recherche 🧠</option>
                            </optgroup>
                            <optgroup label="Llama Sonar (En ligne)">
                                <option value="llama-3.1-sonar-small-128k-online">Llama 3.1 Sonar Small - Rapide ⚡</option>
                                <option value="llama-3.1-sonar-large-128k-online">Llama 3.1 Sonar Large - Puissant</option>
                                <option value="llama-3.1-sonar-huge-128k-online">Llama 3.1 Sonar Huge - Très puissant</option>
                            </optgroup>
                            <optgroup label="Llama (Sans recherche)">
                                <option value="llama-3.1-8b-instruct">Llama 3.1 8B Instruct</option>
                                <option value="llama-3.1-70b-instruct">Llama 3.1 70B Instruct</option>
                            </optgroup>
                        </select>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" name="ai" value="cohere">
                        <span>Cohere</span>
                        <select id="cohere-model-selector" style="margin-left: 10px; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: #fff;">
                            <optgroup label="Command A (Dernière génération) 🌟">
                                <option value="command-a-vision-07-2025" selected>Command A Vision - Vision et texte 🎨</option>
                                <option value="command-a-reasoning-08-2025">Command A Reasoning - Raisonnement avancé 🧠</option>
                            </optgroup>
                            <optgroup label="Command R">
                                <option value="command-r-08-2024">Command R (Août 2024)</option>
                                <option value="command-r7b-12-2024">Command R7B (Déc 2024)</option>
                            </optgroup>
                            <optgroup label="Aya (Multilingue)">
                                <option value="c4ai-aya-expanse-32b">Aya Expanse 32B - Multilingue</option>
                                <option value="c4ai-aya-expanse-8b">Aya Expanse 8B</option>
                                <option value="c4ai-aya-vision-32b">Aya Vision 32B 🎨</option>
                                <option value="c4ai-aya-vision-8b">Aya Vision 8B 🎨</option>
                            </optgroup>
                        </select>
                    </label>
                </div>
            </details>
            
            <details class="expander">
                <summary>⚙️ Paramètres</summary>
                <div class="expander-content">
                    <label>Température</label>
                    <input type="range" min="0" max="100" value="70" class="slider">
                    <label>Max Tokens</label>
                    <input type="number" value="2000" class="input-field">
                </div>
            </details>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value">12</div>
                <div class="stat-label">Conversations</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">156</div>
                <div class="stat-label">Messages</div>
            </div>
        </div>
        
        <!-- Suggestions -->
        <div class="suggestions-section">
            <div class="section-title">💡 Suggestions</div>
            
            <div class="suggestion-card" onclick="useSuggestion('Explique-moi le marketing digital en 3 points clés')">
                <div class="suggestion-icon">📊</div>
                <div class="suggestion-title">Marketing Digital</div>
                <div class="suggestion-desc">Concepts clés expliqués</div>
            </div>
            
            <div class="suggestion-card" onclick="useSuggestion('Écris un post LinkedIn engageant sur l\'IA')">
                <div class="suggestion-icon">📱</div>
                <div class="suggestion-title">Post LinkedIn</div>
                <div class="suggestion-desc">Contenu professionnel</div>
            </div>
            
            <div class="suggestion-card" onclick="useSuggestion('Crée un plan de contenu pour 1 mois')">
                <div class="suggestion-icon">📅</div>
                <div class="suggestion-title">Plan de Contenu</div>
                <div class="suggestion-desc">Stratégie mensuelle</div>
            </div>
            
            <div class="suggestion-card" onclick="useSuggestion('Aide-moi à écrire un email de prospection')">
                <div class="suggestion-icon">📧</div>
                <div class="suggestion-title">Email Prospection</div>
                <div class="suggestion-desc">Template professionnel</div>
            </div>
        </div>
        
        <!-- Templates -->
        <div class="suggestions-section">
            <div class="section-title">📝 Templates</div>
            
            <div class="template-card" onclick="useTemplate('article')">
                <div class="template-title">📄 Article de Blog</div>
                <div class="template-prompt">"Écris un article de 800 mots sur [sujet]"</div>
            </div>
            
            <div class="template-card" onclick="useTemplate('description')">
                <div class="template-title">🛍️ Description Produit</div>
                <div class="template-prompt">"Crée une description de produit pour [produit]"</div>
            </div>
            
            <div class="template-card" onclick="useTemplate('script')">
                <div class="template-title">🎬 Script Vidéo</div>
                <div class="template-prompt">"Écris un script vidéo de 2 min sur [sujet]"</div>
            </div>
            
            <div class="template-card" onclick="useTemplate('code')">
                <div class="template-title">💻 Code</div>
                <div class="template-prompt">"Écris du code [langage] pour [fonctionnalité]"</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="suggestions-section">
            <div class="section-title">⚡ Actions rapides</div>
            <button class="new-chat-btn" onclick="exportChat()">
                📥 Exporter conversation
            </button>
            <button class="new-chat-btn danger" onclick="clearChat()">
                🗑️ Effacer conversation
            </button>
        </div>
    </div>
</div>

<script>
let currentModel = 'gemini';
let currentConversationId = null;
let selectedProviders = ['gemini'];
let currentFilter = 'all';
let activeProviders = new Set(['gemini']);

function selectModel(model) {
    currentModel = model;
    document.querySelectorAll('.model-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Mettre à jour les providers sélectionnés
    const providerMap = {
        'gemini': 'gemini',
        'gpt4': 'openai',
        'claude': 'anthropic'
    };
    selectedProviders = [providerMap[model]];
    
    const modelNames = {
        'gemini': 'Gemini 2.0 Flash',
        'gpt4': 'GPT-4',
        'claude': 'Claude 3.5'
    };
    
    addMessage('ai', `Modèle changé vers ${modelNames[model]} !`);
}

async function newChat() {
    if (confirm('Créer une nouvelle conversation ?')) {
        currentConversationId = null;
        document.getElementById('chatMessages').innerHTML = `
            <div class="message ai">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <strong>Gemini 2.0 Flash</strong>
                    <p>Nouvelle conversation ! Comment puis-je vous aider ?</p>
                    <p class="message-hint">💡 Sélectionnez les IA que vous souhaitez utiliser dans le panneau de droite.</p>
                </div>
            </div>
        `;
        
        // Recharger l'historique
        await loadConversations();
    }
}

async function loadConversations() {
    try {
        const token = getCookie('access_token');
        const response = await fetch('/api/chat/conversations', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const conversations = await response.json();
            const historyContainer = document.getElementById('chatHistory');
            
            if (conversations.length === 0) {
                historyContainer.innerHTML = '<li class="chat-history-item">Aucune conversation</li>';
                return;
            }
            
            historyContainer.innerHTML = conversations.map(conv => `
                <li class="chat-history-item ${conv.id === currentConversationId ? 'active' : ''}" onclick="loadConversation(${conv.id})">
                    <div class="history-title">${conv.title}</div>
                    <div class="history-time">${formatDate(conv.updated_at)}</div>
                </li>
            `).join('');
        }
    } catch (error) {
        console.error('Erreur chargement conversations:', error);
    }
}

async function loadConversation(conversationId) {
    try {
        const token = getCookie('access_token');
        const response = await fetch(`/api/chat/conversations/${conversationId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const conversation = await response.json();
            currentConversationId = conversationId;
            
            // Afficher les messages
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            conversation.messages.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage('user', msg.content);
                } else if (msg.ai_responses) {
                    // Afficher toutes les réponses IA
                    for (const [provider, response] of Object.entries(msg.ai_responses)) {
                        const displayNames = {
                            'OpenAI': 'GPT-4',
                            'Anthropic': 'Claude 3.5',
                            'Google': 'Gemini 2.0 Flash',
                            'Mistral': 'Mistral Large',
                            'Stability': 'Stable Diffusion XL',
                            'Replicate': 'Flux Pro'
                        };
                        const providerName = displayNames[provider] || provider;
                        const content = `<strong>${providerName}</strong><br>${response.content || response}`;
                        addMessage('ai', content, null, provider);
                    }
                } else if (msg.content) {
                    addMessage('ai', msg.content);
                }
            });
            
            // Mettre à jour l'historique
            await loadConversations();
        }
    } catch (error) {
        console.error('Erreur chargement conversation:', error);
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'À l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours}h`;
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return `Il y a ${diffDays} jours`;
    return date.toLocaleDateString('fr-FR');
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Afficher le message utilisateur
    addMessage('user', message);
    input.value = '';
    
    // Récupérer les IA sélectionnées depuis les checkboxes
    const checkedAIs = document.querySelectorAll('.ai-selection-section input[type="checkbox"]:checked');
    const selectedAIs = Array.from(checkedAIs).map(cb => cb.value);
    
    // Mapper les valeurs vers les providers
    const providerMap = {
        'gpt4': 'openai',
        'claude': 'anthropic',
        'gemini': 'google',
        'mistral': 'mistral',
        'cohere': 'cohere',
        'groq': 'groq',
        'deepseek': 'deepseek',
        'perplexity': 'perplexity',
        'dalle': 'dalle',
        'stable-diffusion': 'stability',
        'flux': 'replicate'
    };
    
    const providers = selectedAIs.map(ai => providerMap[ai] || ai).filter(Boolean);
    
    if (providers.length === 0) {
        addMessage('ai', '⚠️ Veuillez sélectionner au moins une IA dans le panneau de droite.');
        return;
    }
    
    // Mapper les providers vers les noms attendus par le backend
    const backendProviderMap = {
        'openai': 'OpenAI',
        'anthropic': 'Anthropic',
        'google': 'Google',
        'mistral': 'Mistral',
        'cohere': 'Cohere',
        'groq': 'Groq',
        'deepseek': 'DeepSeek',
        'perplexity': 'Perplexity',
        'dalle': 'OpenAI',
        'stability': 'Stability',
        'replicate': 'Replicate'
    };
    
    const backendProviders = providers.map(p => backendProviderMap[p] || p);
    
    // Créer le mapping des modèles pour chaque provider
    const selectedModels = {};
    backendProviders.forEach(provider => {
        switch(provider) {
            case 'OpenAI':
                // Récupérer le modèle sélectionné dans le dropdown
                const openaiModelSelector = document.getElementById('openai-model-selector');
                selectedModels[provider] = openaiModelSelector ? openaiModelSelector.value : 'gpt-4o';
                break;
            case 'Anthropic':
                // Récupérer le modèle sélectionné dans le dropdown
                const claudeModelSelector = document.getElementById('claude-model-selector');
                selectedModels[provider] = claudeModelSelector ? claudeModelSelector.value : 'claude-3-5-sonnet-20241022';
                break;
            case 'Google':
                // Récupérer le modèle sélectionné dans le dropdown
                const geminiModelSelector = document.getElementById('gemini-model-selector');
                selectedModels[provider] = geminiModelSelector ? geminiModelSelector.value : 'gemini-2.5-flash';
                break;
            case 'Mistral':
                // Récupérer le modèle sélectionné dans le dropdown
                const mistralModelSelector = document.getElementById('mistral-model-selector');
                selectedModels[provider] = mistralModelSelector ? mistralModelSelector.value : 'mistral-large-latest';
                break;
            case 'Cohere':
                // Récupérer le modèle sélectionné dans le dropdown
                const cohereModelSelector = document.getElementById('cohere-model-selector');
                selectedModels[provider] = cohereModelSelector ? cohereModelSelector.value : 'command-a-vision-07-2025';
                break;
            case 'Groq':
                // Récupérer le modèle sélectionné dans le dropdown
                const groqModelSelector = document.getElementById('groq-model-selector');
                selectedModels[provider] = groqModelSelector ? groqModelSelector.value : 'llama-3.3-70b-versatile';
                break;
            case 'DeepSeek':
                // Récupérer le modèle sélectionné dans le dropdown
                const deepseekModelSelector = document.getElementById('deepseek-model-selector');
                selectedModels[provider] = deepseekModelSelector ? deepseekModelSelector.value : 'deepseek-chat';
                break;
            case 'Perplexity':
                // Récupérer le modèle sélectionné dans le dropdown
                const perplexityModelSelector = document.getElementById('perplexity-model-selector');
                selectedModels[provider] = perplexityModelSelector ? perplexityModelSelector.value : 'sonar';
                break;
            default:
                selectedModels[provider] = '';
        }
    });
    
    // Afficher un message de chargement
    const loadingId = 'loading-' + Date.now();
    addMessage('ai', '⏳ Génération des réponses en cours...', loadingId);
    
    try {
        // Récupérer le token depuis le cookie
        const token = getCookie('access_token');
        
        // Envoyer la requête à l'API
        const response = await fetch('/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                message: message,
                conversation_id: currentConversationId,
                selected_providers: backendProviders,
                selected_models: selectedModels,
                temperature: 0.7,
                max_tokens: 2000
            })
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors de l\'envoi du message');
        }
        
        const data = await response.json();
        
        // Sauvegarder l'ID de conversation
        if (data.conversation_id) {
            currentConversationId = data.conversation_id;
        }
        
        // Supprimer le message de chargement
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        // Afficher les réponses des IA
        console.log('Réponses reçues:', data.ai_responses);
        
        if (data.ai_responses && Object.keys(data.ai_responses).length > 0) {
            for (const [provider, response] of Object.entries(data.ai_responses)) {
                const displayNames = {
                    'OpenAI': 'GPT-4',
                    'Anthropic': 'Claude 3.5',
                    'Google': 'Gemini 2.0 Flash',
                    'Mistral': 'Mistral Large',
                    'Stability': 'Stable Diffusion XL',
                    'Replicate': 'Flux Pro'
                };
                
                const providerName = displayNames[provider] || provider;
                const content = `<strong>${providerName}</strong><br>${response.content || response}`;
                addMessage('ai', content, null, provider);
            }
        } else {
            console.error('Aucune réponse IA dans la réponse:', data);
            addMessage('ai', '❌ Aucune réponse reçue des IA.');
        }
        
    } catch (error) {
        console.error('Erreur:', error);
        // Supprimer le message de chargement
        const loadingMsg = document.getElementById(loadingId);
        if (loadingMsg) loadingMsg.remove();
        
        addMessage('ai', '❌ Erreur lors de la génération de la réponse. Veuillez réessayer.');
    }
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function addMessage(type, content, id = null, provider = null) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    if (id) messageDiv.id = id;
    if (provider) messageDiv.setAttribute('data-provider', provider);
    
    const avatar = type === 'user' ? '👤' : '🤖';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-content">
            ${content}
        </div>
    `;
    
    // Appliquer le filtre actuel si c'est un message IA
    if (type === 'ai' && currentFilter !== 'all' && provider !== currentFilter) {
        messageDiv.style.display = 'none';
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getModelName() {
    const names = {
        'gemini': 'Gemini 2.0 Flash',
        'gpt4': 'GPT-4',
        'claude': 'Claude 3.5'
    };
    return names[currentModel];
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function useSuggestion(text) {
    document.getElementById('chatInput').value = text;
    document.getElementById('chatInput').focus();
}

function useTemplate(type) {
    const templates = {
        'article': 'Écris un article de blog de 800 mots sur [ton sujet]. Inclus une introduction accrocheuse, 3 sections principales avec des sous-titres, et une conclusion avec un appel à l\'action.',
        'description': 'Crée une description de produit convaincante pour [nom du produit]. Mets en avant les bénéfices clés, les caractéristiques uniques, et inclus un appel à l\'action.',
        'script': 'Écris un script vidéo de 2 minutes sur [ton sujet]. Structure : accroche (10s), problème (30s), solution (60s), appel à l\'action (20s).',
        'code': 'Écris du code [langage] pour [fonctionnalité]. Inclus des commentaires explicatifs et des bonnes pratiques.'
    };
    
    document.getElementById('chatInput').value = templates[type];
    document.getElementById('chatInput').focus();
}

async function exportChat() {
    if (!currentConversationId) {
        alert('Aucune conversation à exporter');
        return;
    }
    
    try {
        const token = getCookie('access_token');
        const response = await fetch(`/api/chat/conversations/${currentConversationId}/export?format=txt`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation_${currentConversationId}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Erreur lors de l\'export');
        }
    } catch (error) {
        console.error('Erreur export:', error);
        alert('Erreur lors de l\'export');
    }
}

async function clearChat() {
    if (!currentConversationId) {
        newChat();
        return;
    }
    
    if (confirm('Effacer toute la conversation ?')) {
        try {
            const token = getCookie('access_token');
            const response = await fetch(`/api/chat/conversations/${currentConversationId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                newChat();
            } else {
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            console.error('Erreur suppression:', error);
            alert('Erreur lors de la suppression');
        }
    }
}

// Fonction pour mettre à jour les boutons de filtre d'IA
function updateAIFilterButtons() {
    const checkedAIs = document.querySelectorAll('.ai-selection-section input[type="checkbox"]:checked');
    const selectedAIs = Array.from(checkedAIs).map(cb => cb.value);
    
    const providerMap = {
        'gpt4': 'openai',
        'claude': 'anthropic',
        'gemini': 'google',
        'mistral': 'mistral',
        'dalle': 'dalle',
        'stable-diffusion': 'stability',
        'flux': 'replicate'
    };
    
    const backendProviderMap = {
        'openai': 'OpenAI',
        'anthropic': 'Anthropic',
        'google': 'Google',
        'mistral': 'Mistral',
        'dalle': 'OpenAI',
        'stability': 'Stability',
        'replicate': 'Replicate'
    };
    
    // Fonction pour obtenir le nom du modèle OpenAI sélectionné
    function getOpenAIDisplayName() {
        const selector = document.getElementById('openai-model-selector');
        if (!selector) return 'GPT-4';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'GPT-4';
    }
    
    // Fonction pour obtenir le nom du modèle Claude sélectionné
    function getClaudeDisplayName() {
        const selector = document.getElementById('claude-model-selector');
        if (!selector) return 'Claude 3.5';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Claude 3.5';
    }
    
    // Fonction pour obtenir le nom du modèle Gemini sélectionné
    function getGeminiDisplayName() {
        const selector = document.getElementById('gemini-model-selector');
        if (!selector) return 'Gemini';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Gemini';
    }
    
    // Fonction pour obtenir le nom du modèle Mistral sélectionné
    function getMistralDisplayName() {
        const selector = document.getElementById('mistral-model-selector');
        if (!selector) return 'Mistral Large';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Mistral Large';
    }
    
    // Fonction pour obtenir le nom du modèle Cohere sélectionné
    function getCohereDisplayName() {
        const selector = document.getElementById('cohere-model-selector');
        if (!selector) return 'Cohere';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Cohere';
    }
    
    // Fonction pour obtenir le nom du modèle Groq sélectionné
    function getGroqDisplayName() {
        const selector = document.getElementById('groq-model-selector');
        if (!selector) return 'Groq';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Groq';
    }
    
    // Fonction pour obtenir le nom du modèle DeepSeek sélectionné
    function getDeepSeekDisplayName() {
        const selector = document.getElementById('deepseek-model-selector');
        if (!selector) return 'DeepSeek';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'DeepSeek';
    }
    
    // Fonction pour obtenir le nom du modèle Perplexity sélectionné
    function getPerplexityDisplayName() {
        const selector = document.getElementById('perplexity-model-selector');
        if (!selector) return 'Perplexity';
        const selectedOption = selector.options[selector.selectedIndex];
        return selectedOption ? selectedOption.text : 'Perplexity';
    }
    
    const providerNames = {
        'OpenAI': '🤖 ' + getOpenAIDisplayName(),
        'Anthropic': '🧠 ' + getClaudeDisplayName(),
        'Google': '✨ ' + getGeminiDisplayName(),
        'Mistral': '🌟 ' + getMistralDisplayName(),
        'Cohere': '🔷 ' + getCohereDisplayName(),
        'Groq': '⚡ ' + getGroqDisplayName(),
        'DeepSeek': '🔮 ' + getDeepSeekDisplayName(),
        'Perplexity': '🔍 ' + getPerplexityDisplayName(),
        'Stability': '🖼️ Stable Diffusion XL',
        'Replicate': '⚡ Flux Pro'
    };
    
    const mappedProviders = selectedAIs.map(ai => providerMap[ai] || ai).filter(Boolean);
    const backendProviders = mappedProviders.map(p => backendProviderMap[p] || p);
    activeProviders = new Set(backendProviders);
    
    const selectorDiv = document.getElementById('activeAiSelector');
    selectorDiv.innerHTML = `
        <button class="ai-filter-btn ${currentFilter === 'all' ? 'active' : ''}" data-provider="all" onclick="filterByAI('all')">
            🌐 Toutes les réponses
        </button>
    `;
    
    activeProviders.forEach(provider => {
        const isActive = currentFilter === provider ? 'active' : '';
        selectorDiv.innerHTML += `
            <button class="ai-filter-btn ${isActive}" data-provider="${provider}" onclick="filterByAI('${provider}')">
                ${providerNames[provider] || provider}
            </button>
        `;
    });
}

// Fonction pour filtrer les messages par IA
function filterByAI(provider) {
    currentFilter = provider;
    
    // Mettre à jour les boutons actifs
    document.querySelectorAll('.ai-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filtrer les messages
    const messages = document.querySelectorAll('.message.ai');
    messages.forEach(msg => {
        const msgProvider = msg.getAttribute('data-provider');
        
        if (provider === 'all' || msgProvider === provider) {
            msg.style.display = 'flex';
        } else {
            msg.style.display = 'none';
        }
    });
}

// Écouter les changements de checkboxes
function setupCheckboxListeners() {
    const checkboxes = document.querySelectorAll('.ai-selection-section input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            updateAIFilterButtons();
        });
    });
}

// Charger les conversations au démarrage
document.addEventListener('DOMContentLoaded', () => {
    loadConversations();
    updateAIFilterButtons();
    
    // Attendre que les checkboxes soient chargées
    setTimeout(() => {
        setupCheckboxListeners();
    }, 500);
});
</script>
{% endblock %}
