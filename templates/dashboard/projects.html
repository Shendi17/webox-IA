{% extends "dashboard/base_dashboard.html" %}

{% block title %}Mes Projets - WeBox Studio Créatif{% endblock %}

{% block extra_css %}
<style>
/* Page Header */
.page-header-section {
    background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
    padding: 3rem 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    color: white;
}

.page-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.page-subtitle {
    opacity: 0.9;
}

/* Stats globales */
.global-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.global-stat-card {
    background: rgba(255, 255, 255, 0.2);
    padding: 1rem;
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.global-stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.global-stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Actions */
.projects-actions {
    display: flex;
    gap: 1rem;
}

.btn-primary {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #1a1a2e;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.btn-secondary:hover {
    background: white;
    color: #1a1a2e;
}

/* Toolbar */
.projects-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    gap: 1rem;
    flex-wrap: wrap;
}

.toolbar-left {
    display: flex;
    gap: 1rem;
    flex: 1;
    flex-wrap: wrap;
}

.toolbar-right {
    display: flex;
    gap: 0.5rem;
}

/* Filtres */
.filter-input {
    flex: 1;
    min-width: 300px;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 1rem center;
}

.filter-input:focus {
    outline: none;
    border-color: #667eea;
}

.filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    background: white;
    transition: all 0.3s;
}

.filter-select:focus {
    outline: none;
    border-color: #667eea;
}

/* Toggle vue */
.view-toggle {
    display: flex;
    gap: 0.5rem;
    background: white;
    padding: 0.25rem;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.view-btn {
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.3s;
}

.view-btn:hover {
    background: #f0f0f0;
}

.view-btn.active {
    background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
    color: white;
}

/* Tri */
.sort-select {
    padding: 0.75rem 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    background: white;
}

/* Vue Grille */
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
}

/* Vue Liste */
.projects-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.project-list-item {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.project-list-item:hover {
    transform: translateX(5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* Carte projet */
.project-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    cursor: pointer;
}

.project-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.project-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
}

.project-icon {
    font-size: 3rem;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
    border-radius: 15px;
    flex-shrink: 0;
}

.project-info {
    flex: 1;
}

.project-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.project-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.project-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: #999;
    flex-wrap: wrap;
}

.project-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.badge-type {
    background: #e3f2fd;
    color: #1976d2;
}

.badge-status-active {
    background: #d4edda;
    color: #155724;
}

.badge-status-maintenance {
    background: #fff3cd;
    color: #856404;
}

.badge-status-archived {
    background: #f8d7da;
    color: #721c24;
}

.project-stats {
    display: flex;
    justify-content: space-around;
    padding: 1rem 0;
    border-top: 1px solid #e0e0e0;
    border-bottom: 1px solid #e0e0e0;
    margin: 1rem 0;
}

.stat {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.stat-label {
    font-size: 0.8rem;
    color: #666;
}

.project-url {
    margin-bottom: 1rem;
}

.project-link {
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
}

.project-link:hover {
    text-decoration: underline;
}

.project-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-action {
    flex: 1;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-open {
    background: #4169e1;
    color: white;
}

.btn-open:hover {
    background: #3558c9;
}

.btn-deploy {
    background: #28a745;
    color: white;
}

.btn-deploy:hover {
    background: #218838;
}

.btn-settings {
    background: #6c757d;
    color: white;
}

.btn-settings:hover {
    background: #5a6268;
}

/* État vide */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 1rem;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.empty-description {
    color: #666;
    margin-bottom: 2rem;
}

/* Loading */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 15px;
}

.skeleton-card {
    height: 300px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Utilitaires */
.hidden {
    display: none;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .projects-toolbar {
        flex-direction: column;
    }
    
    .toolbar-left {
        width: 100%;
    }
    
    .filter-input {
        min-width: 100%;
    }
    
    .projects-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header avec Stats -->
<div class="page-header-section">
    <div class="page-header-content">
        <div>
            <h1 class="page-title">🏗️ Mes Projets</h1>
            <p class="page-subtitle">Gérez tous vos projets Studio Créatif en un seul endroit</p>
        </div>
        <div class="projects-actions">
            <button class="btn-secondary" onclick="importProject()">
                📥 Importer
            </button>
            <button class="btn-primary" onclick="createProject()">
                ➕ Nouveau Projet
            </button>
        </div>
    </div>
    
    <!-- Stats globales -->
    <div class="global-stats">
        <div class="global-stat-card">
            <div class="global-stat-value" id="totalProjects">0</div>
            <div class="global-stat-label">Projets totaux</div>
        </div>
        <div class="global-stat-card">
            <div class="global-stat-value" id="activeProjects">0</div>
            <div class="global-stat-label">Projets actifs</div>
        </div>
        <div class="global-stat-card">
            <div class="global-stat-value" id="deployedProjects">0</div>
            <div class="global-stat-label">Déployés</div>
        </div>
        <div class="global-stat-card">
            <div class="global-stat-value" id="totalFiles">0</div>
            <div class="global-stat-label">Fichiers totaux</div>
        </div>
    </div>
</div>

<!-- Toolbar : Filtres + Vue + Tri -->
<div class="projects-toolbar">
    <div class="toolbar-left">
        <input type="text" class="filter-input" placeholder="🔍 Rechercher un projet..." id="searchInput">
        
        <select class="filter-select" id="categoryFilter">
            <option value="">Toutes catégories</option>
            <option value="podcast">🎙️ Podcast</option>
            <option value="avatar">👤 Avatar</option>
            <option value="series">📺 Série</option>
            <option value="pwa">📱 PWA</option>
            <option value="document">📄 Document</option>
            <option value="agent">🤖 Agent IA</option>
            <option value="other">🌐 Autre</option>
        </select>
        
        <select class="filter-select" id="statusFilter">
            <option value="">Tous statuts</option>
            <option value="active">✅ Actif</option>
            <option value="maintenance">⚠️ Maintenance</option>
            <option value="archived">📦 Archivé</option>
        </select>
    </div>
    
    <div class="toolbar-right">
        <select class="sort-select" id="sortSelect">
            <option value="date-desc">📅 Plus récent</option>
            <option value="date-asc">📅 Plus ancien</option>
            <option value="name-asc">🔤 Nom A-Z</option>
            <option value="name-desc">🔤 Nom Z-A</option>
            <option value="files-desc">📁 Plus de fichiers</option>
        </select>
        
        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('grid')" title="Vue grille">
                ▦
            </button>
            <button class="view-btn" onclick="switchView('list')" title="Vue liste">
                ☰
            </button>
        </div>
    </div>
</div>

<!-- Conteneur projets (grille par défaut) -->
<div class="projects-grid" id="projectsContainer">
    <!-- Loading skeletons -->
    <div class="skeleton skeleton-card"></div>
    <div class="skeleton skeleton-card"></div>
    <div class="skeleton skeleton-card"></div>
</div>

<!-- État vide -->
<div class="empty-state hidden" id="emptyState">
    <div class="empty-icon">🏗️</div>
    <div class="empty-title">Aucun projet pour le moment</div>
    <div class="empty-description">Créez votre premier projet Studio Créatif ou importez-en un existant</div>
    <button class="btn-primary" onclick="createProject()">
        ➕ Créer mon premier projet
    </button>
</div>

<script>
let allProjects = [];
let currentView = 'grid';
let currentSort = 'date-desc';

// ==================== HELPERS ====================
function getProjectIcon(category) {
    const icons = {
        'podcast': '🎙️',
        'avatar': '👤',
        'series': '📺',
        'pwa': '📱',
        'document': '📄',
        'agent': '🤖',
        'static': '📄',
        'react': '⚛️',
        'vue': '💚',
        'nextjs': '▲',
        'django': '🐍',
        'fastapi': '⚡'
    };
    return icons[category] || '🌐';
}

function getStatusBadge(status) {
    const classes = {
        'active': 'badge-status-active',
        'maintenance': 'badge-status-maintenance',
        'archived': 'badge-status-archived'
    };
    const labels = {
        'active': '✅ Actif',
        'maintenance': '⚠️ Maintenance',
        'archived': '📦 Archivé'
    };
    return `<span class="project-badge ${classes[status] || ''}">${labels[status] || status}</span>`;
}

function formatNumber(num) {
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num;
}

// ==================== CHARGEMENT ====================
async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const data = await response.json();
        
        allProjects = data.projects || [];
        updateGlobalStats();
        applyFiltersAndSort();
    } catch (error) {
        console.error('Erreur chargement projets:', error);
        displayProjects([]);
    }
}

function updateGlobalStats() {
    document.getElementById('totalProjects').textContent = allProjects.length;
    document.getElementById('activeProjects').textContent = allProjects.filter(p => p.status === 'active').length;
    document.getElementById('deployedProjects').textContent = allProjects.filter(p => p.prod_url).length;
    document.getElementById('totalFiles').textContent = formatNumber(allProjects.reduce((sum, p) => sum + (p.total_files || 0), 0));
}

// ==================== AFFICHAGE ====================
function displayProjects(projects) {
    const container = document.getElementById('projectsContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (projects.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    if (currentView === 'grid') {
        container.className = 'projects-grid';
        container.innerHTML = projects.map(project => createProjectCard(project)).join('');
    } else {
        container.className = 'projects-list';
        container.innerHTML = projects.map(project => createProjectListItem(project)).join('');
    }
}

function createProjectCard(project) {
    return `
        <div class="project-card" onclick="openProject(${project.id})">
            <div class="project-header">
                <div class="project-icon">${getProjectIcon(project.category || project.project_type)}</div>
                <div class="project-info">
                    <div class="project-name">${project.name}</div>
                    <div class="project-description">${project.description || 'Aucune description'}</div>
                    <div class="project-meta">
                        <span class="project-badge badge-type">${project.category || project.project_type}</span>
                        ${getStatusBadge(project.status)}
                    </div>
                </div>
            </div>
            
            <div class="project-stats">
                <div class="stat">
                    <div class="stat-value">${project.total_files || 0}</div>
                    <div class="stat-label">Fichiers</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${formatNumber(project.total_lines || 0)}</div>
                    <div class="stat-label">Lignes</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${project.prod_url ? '✅' : '📍'}</div>
                    <div class="stat-label">${project.prod_url ? 'Déployé' : 'Local'}</div>
                </div>
            </div>
            
            ${project.prod_url ? `<div class="project-url"><a href="${project.prod_url}" target="_blank" class="project-link" onclick="event.stopPropagation()">🔗 ${project.prod_url}</a></div>` : ''}
            
            <div class="project-actions" onclick="event.stopPropagation()">
                <button class="btn-action btn-open" onclick="openEditor(${project.id})">Ouvrir</button>
                <button class="btn-action btn-deploy" onclick="deployProject(${project.id})">Déployer</button>
                <button class="btn-action btn-settings" onclick="openSettings(${project.id})">⚙️</button>
            </div>
        </div>
    `;
}

function createProjectListItem(project) {
    return `
        <div class="project-list-item" onclick="openProject(${project.id})">
            <div class="project-icon">${getProjectIcon(project.category || project.project_type)}</div>
            <div class="project-info">
                <div class="project-name">${project.name}</div>
                <div class="project-description">${project.description || 'Aucune description'}</div>
            </div>
            <div class="project-meta">
                <span class="project-badge badge-type">${project.category || project.project_type}</span>
                ${getStatusBadge(project.status)}
            </div>
            <div class="stat">
                <div class="stat-value">${project.total_files || 0}</div>
                <div class="stat-label">Fichiers</div>
            </div>
            <div class="project-actions" onclick="event.stopPropagation()">
                <button class="btn-action btn-open" onclick="openEditor(${project.id})">Ouvrir</button>
                <button class="btn-action btn-deploy" onclick="deployProject(${project.id})">Déployer</button>
                <button class="btn-action btn-settings" onclick="openSettings(${project.id})">⚙️</button>
            </div>
        </div>
    `;
}

// ==================== FILTRES & TRI ====================
function applyFiltersAndSort() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    let filtered = allProjects.filter(project => {
        const matchSearch = project.name.toLowerCase().includes(search) || 
                          (project.description && project.description.toLowerCase().includes(search));
        const matchCategory = !category || project.category === category || project.project_type === category;
        const matchStatus = !status || project.status === status;
        
        return matchSearch && matchCategory && matchStatus;
    });
    
    // Tri
    filtered = sortProjects(filtered, currentSort);
    
    displayProjects(filtered);
}

function sortProjects(projects, sortBy) {
    const sorted = [...projects];
    
    switch(sortBy) {
        case 'date-desc':
            return sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        case 'date-asc':
            return sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        case 'name-asc':
            return sorted.sort((a, b) => a.name.localeCompare(b.name));
        case 'name-desc':
            return sorted.sort((a, b) => b.name.localeCompare(a.name));
        case 'files-desc':
            return sorted.sort((a, b) => (b.total_files || 0) - (a.total_files || 0));
        default:
            return sorted;
    }
}

// ==================== ACTIONS ====================
function switchView(view) {
    currentView = view;
    
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    applyFiltersAndSort();
}

function createProject() {
    window.location.href = '/projects/create';
}

function importProject() {
    alert('Import de projet - À implémenter');
}

function openProject(id) {
    window.location.href = `/projects/${id}`;
}

function openEditor(id) {
    window.location.href = `/projects/${id}/editor`;
}

function deployProject(id) {
    alert(`Déploiement du projet ${id} - À implémenter`);
}

function openSettings(id) {
    window.location.href = `/projects/${id}/settings`;
}

// ==================== EVENT LISTENERS ====================
document.getElementById('searchInput').addEventListener('input', applyFiltersAndSort);
document.getElementById('categoryFilter').addEventListener('change', applyFiltersAndSort);
document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSort);
document.getElementById('sortSelect').addEventListener('change', (e) => {
    currentSort = e.target.value;
    applyFiltersAndSort();
});

// Charger au démarrage
document.addEventListener('DOMContentLoaded', loadProjects);
</script>
{% endblock %}
